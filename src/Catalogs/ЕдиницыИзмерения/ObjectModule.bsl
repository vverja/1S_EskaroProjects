
// Обработчик события ПередЗаписью .
//
Процедура ПередЗаписью(Отказ)

	Если НЕ ОбменДанными.Загрузка
		И ТипЗнч(Владелец) = Тип("СправочникСсылка.Номенклатура") Тогда
		Если ЕдиницаПоКлассификатору = Справочники.КлассификаторЕдиницИзмерения.Паллета ИЛИ ЕдиницаПоКлассификатору = Справочники.КлассификаторЕдиницИзмерения.Коробка Тогда
			Если НЕ РольДоступна("УправлениеСкладскойЛогистикой") Тогда
				Отказ = Истина;
				ОбщегоНазначения.СообщитьОбОшибке("Недостаточно прав для редактирования единицы """ + Наименование + """!", Отказ);
			КонецЕсли;
		Иначе
			Если НЕ РольДоступна("РедактированиеНоменклатуры") И НЕ ЗначениеЗаполнено(ЕдиницаПоКлассификатору) Тогда
				Отказ = Истина;
				ОбщегоНазначения.СообщитьОбОшибке("Недостаточно прав для редактирования единицы """ + Наименование + """ без установки соответствия по классификатору!", Отказ);
			КонецЕсли;
		КонецЕсли;
		
		Если Владелец.ЕдиницаХраненияОстатков = Ссылка Тогда
			
			Запрос = Новый Запрос;
			Запрос.УстановитьПараметр("ТекущийЭлемент", ЭтотОбъект.Ссылка);
			
			Запрос.Текст =
			"ВЫБРАТЬ
			| ЕдиницыИзмерения.Ссылка КАК Элемент,
			| ЕдиницыИзмерения.Коэффициент КАК Коэффициент
			|ИЗ
			| Справочник.ЕдиницыИзмерения КАК ЕдиницыИзмерения
			|
			|ГДЕ
			| ЕдиницыИзмерения.Ссылка = &ТекущийЭлемент";
			
			Выборка = Запрос.Выполнить().Выбрать();
			
			Если Выборка.Следующий() Тогда
			//Если Выборка.Следующий()
				//И СокрЛП(глЗначениеПеременной("глТекущийПользователь")) <> "Федоровская Анна" Тогда
				//И СокрЛП(глЗначениеПеременной("глТекущийПользователь")) <> "Смартис" Тогда
				Если Выборка.Коэффициент <> Коэффициент Тогда
					Если ПолныеПрава.Номенклатура_СуществуютСсылки(Владелец, Неопределено) Тогда
						ОбщегоНазначения.СообщитьОбОшибке("Единица """ + Наименование + """ является единицей хранения остатков для """ + Владелец.Наименование + """ и уже участвует в товародвижении. Изменить коэффициент уже нельзя!", Отказ);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;
	
	Если Не ОбменДанными.Загрузка
		И Не Отказ
		И Коэффициент = 0 Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Для "+СокрЛП(Владелец)+" у единицы измерения "+СокрЛП(Ссылка)+" не задан коэффициент! Он будет установлен равным 1.");
		Коэффициент = 1;
	КонецЕсли;

КонецПроцедуры // ПередЗаписью()

