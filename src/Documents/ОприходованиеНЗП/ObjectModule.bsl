Перем мУдалятьДвижения;

// Строки, хранят реквизиты имеющие смысл только для бух. учета и упр. соответственно
// в случае если документ не отражается в каком-то виде учета, делаются невидимыми
Перем мСтрокаРеквизитыБухУчета Экспорт; // (Регл)
Перем мСтрокаРеквизитыУпрУчета Экспорт; // (Упр)

Перем мВалютаРегламентированногоУчета Экспорт; // (Упр)
Перем мВалютаУправленческогоУчета     Экспорт; // (Регл)

Перем мУчетнаяПолитика;                 // (Общ)
Перем мУчетнаяПолитикаРегл;             // (Регл)

////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ДОКУМЕНТА

#Если Клиент Тогда

// Функция формирование печатной формы документа "Оприходование НЗП"
//
Функция ПечатьОприходованиеНЗП(ТипУчета)
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	ОприходованиеНЗП.Ссылка,
	|	ОприходованиеНЗП.Представление,
	|	ОприходованиеНЗП.Организация,
	|	ВЫБОР
	|		КОГДА &ТипУчета = ""Упр""
	|			ТОГДА ОприходованиеНЗП.Подразделение
	|		ИНАЧЕ ОприходованиеНЗП.ПодразделениеОрганизации
	|	КОНЕЦ КАК Подразделение,
	|	ОприходованиеНЗП.ДокИнвентаризация КАК Основание,
	|	ОприходованиеНЗП.Организация.Представление КАК ПечОрганизация,
	|	ОприходованиеНЗП.ДокИнвентаризация.Представление КАК ПечОснование,
	|	ВЫБОР
	|		КОГДА &ТипУчета = ""Упр""
	|			ТОГДА ОприходованиеНЗП.Подразделение.Представление
	|		ИНАЧЕ ОприходованиеНЗП.ПодразделениеОрганизации.Представление
	|	КОНЕЦ КАК ПечПодразделение,
	|	ОприходованиеНЗП.Материалы.(
	|		НомерСтроки                КАК НомерСтроки,
	|		Номенклатура               КАК Материал,
	|		ХарактеристикаНоменклатуры КАК Характеристика,
	|		СерияНоменклатуры          КАК Серия,
	|		КоличествоМест             КАК КолМест,
	|		ЕдиницаИзмеренияМест       КАК ЕдИзмМест,
	|		ЕдиницаИзмерения           КАК ЕдИзм,
	|		Количество,
	|		ВЫБОР КОГДА &ТипУчета = ""Упр"" ТОГДА
	|			ОприходованиеНЗП.Материалы.Цена
	|		ИНАЧЕ 
	|			ОприходованиеНЗП.Материалы.СуммаРегл / Количество
	|		КОНЕЦ КАК Цена,
	|		ВЫБОР КОГДА &ТипУчета = ""Упр"" ТОГДА
	|			ОприходованиеНЗП.Материалы.Сумма
	|		ИНАЧЕ 
	|			ОприходованиеНЗП.Материалы.СуммаРегл
	|		КОНЕЦ КАК Сумма,
	|		СтатьяЗатрат,
	|		Заказ,
	|		НоменклатурнаяГруппа               КАК НомГруппа,
	|		СчетЗатрат                         КАК Счет,
	|		СтатьяЗатрат.Представление         КАК ПечСтатьяЗатрат,
	|		Заказ.Представление                КАК ПечЗаказ,
	|		НоменклатурнаяГруппа.Представление КАК ПечНомГруппа,
	|		СчетЗатрат.Представление           КАК ПечСчет,
	|		СтатьяЗатрат.ХарактерЗатрат        КАК ПечХарактЗатрат,
	|		ЕдиницаИзмерения.Представление     КАК ПечЕдИзм,
	|		ЕдиницаИзмеренияМест.Представление КАК ПечЕдИзмМест,
	|		Номенклатура.Код                   КАК Код,
	|		Номенклатура.Артикул               КАК Артикул
	|	)
	|ИЗ
	|	Документ.ОприходованиеНЗП КАК ОприходованиеНЗП
	|ГДЕ
	|	ОприходованиеНЗП.Ссылка = &ТекДок
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	Запрос.УстановитьПараметр( "ТекДок",   Ссылка);
	Запрос.УстановитьПараметр( "ТипУчета", ТипУчета);
	
	РезультатЗапроса = Запрос.Выполнить();
	Шапка = РезультатЗапроса.Выбрать();
	Шапка.Следующий();
	
	ТабДок = Новый ТабличныйДокумент;
	ТабДок.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ОприходованиеНЗП_ОприходованиеНЗП";
	
	Макет = ПолучитьМакет("ОприходованиеНЗП");
	
	// Параметры вывода
	ДопКолонка = Константы.ДополнительнаяКолонкаПечатныхФормДокументов.Получить();
	КолАртикул = ?( ДопКолонка = Перечисления.ДополнительнаяКолонкаПечатныхФормДокументов.Артикул, "Артикул",
				 ?( ДопКолонка = Перечисления.ДополнительнаяКолонкаПечатныхФормДокументов.Код,     "Код", ""));
	ФлагВыводКода = НЕ ПустаяСтрока(КолАртикул);
	ФлагВыводМест = Ложь;
	ТабЧасть = Шапка.Материалы.Выбрать();
	Пока ТабЧасть.Следующий() Цикл
		Если ТабЧасть.КолМест <> 0 ИЛИ ЗначениеЗаполнено(ТабЧасть.ЕдИзмМест) Тогда
			ФлагВыводМест = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	ФлагВыводСумм = ТипСтоимости = Перечисления.ВидыНормативнойСтоимостиПроизводства.Фиксированная;
	
	// Вывод заголовка
	Область = Макет.ПолучитьОбласть("Заголовок|Начало");
	Область.Параметры.Заголовок = ОбщегоНазначения.СформироватьЗаголовокДокумента( ЭтотОбъект);
	ТабДок.Вывести(Область);
	
	Если ФлагВыводКода Тогда
		Область = Макет.ПолучитьОбласть("Заголовок|Артикул");
		ТабДок.Присоединить(Область);
	КонецЕсли;
	
	Область = Макет.ПолучитьОбласть("Заголовок|Материал");
	ТабДок.Присоединить(Область);
	
	Если ФлагВыводМест Тогда
		Область = Макет.ПолучитьОбласть("Заголовок|КолМест");
		ТабДок.Присоединить(Область);
	КонецЕсли;
	
	Область = Макет.ПолучитьОбласть("Заголовок|Количество");
	ТабДок.Присоединить(Область);
	
	Если ФлагВыводСумм Тогда
		Область = Макет.ПолучитьОбласть("Заголовок|Суммы");
		ТабДок.Присоединить(Область);
	КонецЕсли;
	
	Если ФлагВыводКода Тогда
		
		Область = Макет.ПолучитьОбласть("ДокШапка|Начало");
		ТабДок.Вывести( Область);
		
		Область = Макет.ПолучитьОбласть("ДокШапка|Артикул");
		ТабДок.Присоединить( Область);
		
		Область = Макет.ПолучитьОбласть("ДокШапка|Материал");
		
	Иначе
		
		Область = Макет.ПолучитьОбласть("ДокШапкаБезАртикула|НачалоБезАртикула");
		ТабДок.Вывести( Область);
		
		Область = Макет.ПолучитьОбласть("ДокШапкаБезАртикула|МатериалБезАртикула");
		
	КонецЕсли;
	
	Область.Параметры.Подразделение    = Шапка.Подразделение;
	Область.Параметры.ПечПодразделение = Шапка.ПечПодразделение;
	Область.Параметры.Организация      = Шапка.Организация;
	Область.Параметры.ПечОрганизация   = Шапка.ПечОрганизация;
	Область.Параметры.Основание        = Шапка.Основание;
	Область.Параметры.ПечОснование     = Шапка.ПечОснование;
		
	ТабДок.Присоединить( Область);
	
	// Вывод шапки табличной части
	ОбластьНач  = Макет.ПолучитьОбласть("ТабШапка|Начало");
	ТабДок.Вывести( ОбластьНач);
	
	Если ФлагВыводКода Тогда
		ОбластьКод = Макет.ПолучитьОбласть("ТабШапка|Артикул");
		ОбластьКод.Параметры.ЗаголовокАртикул = КолАртикул;
		ТабДок.Присоединить( ОбластьКод);
	КонецЕсли;
	
	ОбластьМат = Макет.ПолучитьОбласть("ТабШапка|Материал");
	ОбластьМат.Параметры.ЗаголовокСчет = ?(ТипУчета = "Бух", "Счет", "Характер затрат");
	ТабДок.Присоединить( ОбластьМат);
	
	Если ФлагВыводМест Тогда
		ОбластьМест = Макет.ПолучитьОбласть("ТабШапка|КолМест");
		ТабДок.Присоединить( ОбластьМест);
	КонецЕсли;
	
	ОбластьКол  = Макет.ПолучитьОбласть("ТабШапка|Количество");
	Если НЕ ФлагВыводСумм Тогда
		ОбластьКол.ТекущаяОбласть.ГраницаСправа = Новый Линия( ТипЛинииРисункаТабличногоДокумента.Сплошная, 2);
	КонецЕсли;
	ТабДок.Присоединить( ОбластьКол);
	
	Если ФлагВыводСумм Тогда
		ОбластьСумм = Макет.ПолучитьОбласть("ТабШапка|Суммы");
		ТабДок.Присоединить( ОбластьСумм);
	КонецЕсли;
	
	// Вывод табличной части
	ОбластьНач  = Макет.ПолучитьОбласть("ТабСтрока|Начало");
	ОбластьКод  = Макет.ПолучитьОбласть("ТабСтрока|Артикул");
	ОбластьМат  = Макет.ПолучитьОбласть("ТабСтрока|Материал");
	ОбластьМест = Макет.ПолучитьОбласть("ТабСтрока|КолМест");
	ОбластьКол  = Макет.ПолучитьОбласть("ТабСтрока|Количество");
	ОбластьСум  = Макет.ПолучитьОбласть("ТабСтрока|Суммы");
	
	ТабЧасть = Шапка.Материалы.Выбрать();
	СуммаИтого = 0;
	
	Пока ТабЧасть.Следующий() Цикл
		
		ОбластьНач.Параметры.ПечНомер = ТабЧасть.НомерСтроки;
		ТабДок.Вывести(ОбластьНач);
		Если ФлагВыводКода Тогда
			ОбластьКод.Параметры.ПечАртикул = ТабЧасть[КолАртикул];
			ТабДок.Присоединить(ОбластьКод);
		КонецЕсли;
		
		ОбластьМат.Параметры.ПечМатериал     = СокрЛП( ТабЧасть.Материал) + ФормированиеПечатныхФорм.ПредставлениеСерий( ТабЧасть);
		ОбластьМат.Параметры.Материал        = ТабЧасть.Материал;
		ОбластьМат.Параметры.ПечСтатьяЗатрат = ТабЧасть.ПечСтатьяЗатрат;
		ОбластьМат.Параметры.СтатьяЗатрат    = ТабЧасть.СтатьяЗатрат;
		ОбластьМат.Параметры.ПечЗаказ        = ТабЧасть.ПечЗаказ;
		ОбластьМат.Параметры.Заказ           = ТабЧасть.Заказ;
		ОбластьМат.Параметры.ПечНомГруппа    = ТабЧасть.ПечНомГруппа;
		ОбластьМат.Параметры.НомГруппа       = ТабЧасть.НомГруппа;
		Если ТипУчета = "Бух" Тогда
			ОбластьМат.Параметры.ПечСчет = ТабЧасть.ПечСчет;
			ОбластьМат.Параметры.Счет    = ТабЧасть.Счет;
		Иначе
			ОбластьМат.Параметры.ПечСчет = ТабЧасть.ПечХарактЗатрат;
			ОбластьМат.Параметры.Счет    = Неопределено;
		КонецЕсли;
		ТабДок.Присоединить(ОбластьМат);
		
		Если ФлагВыводМест Тогда
			ОбластьМест.Параметры.ПечЕдИзмМест = ТабЧасть.ПечЕдИзмМест;
			ОбластьМест.Параметры.КолМест      = ТабЧасть.КолМест;
			ТабДок.Присоединить(ОбластьМест);
		КонецЕсли;
		
		ОбластьКол.Параметры.ПечЕдИзм = ТабЧасть.ПечЕдИзм;
		ОбластьКол.Параметры.Колво    = ТабЧасть.Количество;
		Если НЕ ФлагВыводСумм Тогда
			ОбластьКол.Область( 1, 2, 1, 2).ГраницаСправа = Новый Линия( ТипЛинииРисункаТабличногоДокумента.Сплошная, 2);
		КонецЕсли;
		ТабДок.Присоединить(ОбластьКол);
		
		Если ФлагВыводСумм Тогда
			ОбластьСум.Параметры.Цена  = Окр(ТабЧасть.Цена, 2, 1);
			ОбластьСум.Параметры.Сумма = ТабЧасть.Сумма;
			ТабДок.Присоединить(ОбластьСум);
		КонецЕсли;
		
		СуммаИтого = СуммаИтого + ТабЧасть.Сумма;
		
	КонецЦикла;
	
	// Вывод итогов документа
	Если ФлагВыводСумм Тогда
		
		ОбластьИтог = Макет.ПолучитьОбласть( "ИтогСумма|Начало");
		ВалСумм = ?(ТипУчета = "Бух", мВалютаРегламентированногоУчета, мВалютаУправленческогоУчета);
		ОбластьИтог.Параметры.ИтоговаяСтрока = "Всего наименований: " + ТабЧасть.Количество() + ", на сумму " + ОбщегоНазначения.ФорматСумм( СуммаИтого, ВалСумм);
		ОбластьИтог.Параметры.СуммаПрописью  = ОбщегоНазначения.СформироватьСуммуПрописью( СуммаИтого, ВалСумм);
		ТабДок.Вывести( ОбластьИтог);
		
		Если ФлагВыводКода Тогда
			ОбластьИтог = Макет.ПолучитьОбласть( "ИтогСумма|Артикул");
			ТабДок.Присоединить( ОбластьИтог);
		КонецЕсли;
		
		ОбластьИтог = Макет.ПолучитьОбласть( "ИтогСумма|Материал");
		ТабДок.Присоединить( ОбластьИтог);
		
		Если ФлагВыводМест Тогда
			ОбластьИтог = Макет.ПолучитьОбласть( "ИтогСумма|КолМест");
			ТабДок.Присоединить( ОбластьИтог);
		КонецЕсли;
		
		ОбластьИтог = Макет.ПолучитьОбласть( "ИтогСумма|Количество");
		ТабДок.Присоединить( ОбластьИтог);
		
		ОбластьИтог = Макет.ПолучитьОбласть( "ИтогСумма|Суммы");
		ОбластьИтог.Параметры.ИтогоСумма = СуммаИтого;
		ТабДок.Присоединить( ОбластьИтог);
		
	Иначе
		
		ОбластьИтог = Макет.ПолучитьОбласть("ИтогКол|Начало");
		ОбластьИтог.Параметры.ИтоговаяСтрока = "Всего наименований: " + ТабЧасть.Количество();
		ТабДок.Вывести( ОбластьИтог);
		
		Если ФлагВыводКода Тогда
			ОбластьИтог = Макет.ПолучитьОбласть( "ИтогКол|Артикул");
			ТабДок.Присоединить( ОбластьИтог);
		КонецЕсли;
		
		ОбластьИтог = Макет.ПолучитьОбласть( "ИтогКол|Материал");
		ТабДок.Присоединить( ОбластьИтог);
		
		Если ФлагВыводМест Тогда
			ОбластьИтог = Макет.ПолучитьОбласть( "ИтогКол|КолМест");
			ТабДок.Присоединить( ОбластьИтог);
		КонецЕсли;
		
		ОбластьИтог = Макет.ПолучитьОбласть( "ИтогКол|Количество");
		ТабДок.Присоединить( ОбластьИтог);
		
	КонецЕсли;
	
	
	Возврат ТабДок;
	
КонецФункции // ПечатьОприходованиеНЗП()
	
// Возвращает доступные варианты печати документа
//
// Возвращаемое значение:
//  Структура, каждая строка которой соответствует одному из вариантов печати
//  
Функция ПолучитьСтруктуруПечатныхФорм() Экспорт
	
	СтруктПечФорм = Новый Структура;
	Если ОтражатьВУправленческомУчете И ОтражатьВБухгалтерскомУчете Тогда
		СтруктПечФорм.Вставить( "ОприходованиеНЗП_Упр", "Оприходование НЗП (упр.)");
		СтруктПечФорм.Вставить( "ОприходованиеНЗП_Бух", "Оприходование НЗП (регл.)");
	Иначе
		СтруктПечФорм.Вставить( "ОприходованиеНЗП", "Оприходование НЗП");
	КонецЕсли;
	
	Возврат СтруктПечФорм;

КонецФункции // ПолучитьСтруктуруПечатныхФорм()

// Процедура осуществляет печать документа. Можно направить печать на 
// экран или принтер, а также распечатать необходимое количество копий.
//
//  Название макета печати передается в качестве параметра,
// по переданному названию находим имя макета в соответствии.
//
// Параметры:
//  НазваниеМакета - строка, название макета.
//
Процедура Печать(ИмяМакета, КоличествоЭкземпляров = 1, НаПринтер = Ложь) Экспорт

	Если ЭтоНовый() Тогда
		Предупреждение("Документ можно распечатать только после его записи");
		Возврат;
	ИначеЕсли Не УправлениеДопПравамиПользователей.РазрешитьПечатьНепроведенныхДокументов(Проведен) Тогда
		Предупреждение("Недостаточно полномочий для печати непроведенного документа!");
		Возврат;
	КонецЕсли;

	Если Не РаботаСДиалогами.ПроверитьМодифицированность(ЭтотОбъект) Тогда
		Возврат;
	КонецЕсли;

	Если ИмяМакета = "ОприходованиеНЗП" ИЛИ ИмяМакета = "ОприходованиеНЗП_Упр" ИЛИ ИмяМакета = "ОприходованиеНЗП_Бух" Тогда
		
		ТипУчета = ?( ИмяМакета = "ОприходованиеНЗП_Упр", "Упр",
				   ?( ИмяМакета = "ОприходованиеНЗП_Бух", "Бух",
				   ?( ОтражатьВУправленческомУчете, "Упр", "Бух")));
				   
		ТабДокумент = ПечатьОприходованиеНЗП(ТипУчета);
		
	ИначеЕсли ТипЗнч(ИмяМакета) = Тип("ДвоичныеДанные") Тогда

		ТабДокумент = УниверсальныеМеханизмы.НапечататьВнешнююФорму(Ссылка, ИмяМакета);
		
		Если ТабДокумент = Неопределено Тогда
			Возврат
		КонецЕсли; 
		
	КонецЕсли;

	УниверсальныеМеханизмы.НапечататьДокумент(ТабДокумент, КоличествоЭкземпляров, НаПринтер, ОбщегоНазначения.СформироватьЗаголовокДокумента(ЭтотОбъект), Ссылка);

КонецПроцедуры // Печать

#КонецЕсли

// Процедура заполняет структуры именами реквизитов, которые имеют смысл
// только для определенного вида учета
//
Процедура ЗаполнитьСписокРеквизитовЗависимыхОтТиповУчета() Экспорт
	
	ЗаполнитьСписокРеквизитовЗависимыхОтТиповУчетаУпр();
	ЗаполнитьСписокРеквизитовЗависимыхОтТиповУчетаРегл();
	
КонецПроцедуры // ЗаполнитьСписокРеквизитовЗависимыхОтТиповУчета()

// Процедура заполняет структуры именами реквизитов, которые имеют смысл
// только для упр. учета
//
Процедура ЗаполнитьСписокРеквизитовЗависимыхОтТиповУчетаУпр()
	
	мСтрокаРеквизитыУпрУчета = "Подразделение, НадписьПодразделение, Материалы.Сумма";
	
КонецПроцедуры // ЗаполнитьСписокРеквизитовЗависимыхОтТиповУчетаУпр()

// Процедура заполняет структуры именами реквизитов, которые имеют смысл
// только для регл. учета
//
Процедура ЗаполнитьСписокРеквизитовЗависимыхОтТиповУчетаРегл()
	
	мСтрокаРеквизитыБухУчета = "ПодразделениеОрганизации, НадписьПодразделениеОрганизации,
		|СчетКт,      НадписьСчетКт,
		|СубконтоКт1, НадписьСубконтоКт1,
		|СубконтоКт2, НадписьСубконтоКт2,
		|СубконтоКт3, НадписьСубконтоКт3,
		|НалоговоеНазначениеДоходовИЗатрат, НадписьНалоговоеНазначениеДоходовИЗатрат,
		|Материалы.СчетЗатрат,
		|Материалы.СуммаРегл,
		|Материалы.НалоговоеНазначение, Материалы.СуммаНал, Материалы.СуммаНДС, Материалы.СуммаНДСКредит";	
	
КонецПроцедуры // ЗаполнитьСписокРеквизитовЗависимыхОтТиповУчетаРегл()

// Процедура проверяет правильность заполнения реквизитов документа
//
Процедура ПроверкаРеквизитов(Отказ, Заголовок, СтруктураШапкиДокумента) Экспорт
	
	// Документ должен принадлежать хотя бы к одному виду учета (управленческий, бухгалтерский, налоговый)
	ОбщегоНазначения.ПроверитьПринадлежностьКВидамУчета(СтруктураШапкиДокумента, Отказ, Заголовок);
	
	ЗаполнитьСписокРеквизитовЗависимыхОтТиповУчета();
	
	РеквизитыШапки = "Организация, ТипСтоимости";
	ДополнитьРеквизитыШапкиУпр(РеквизитыШапки);
	ДополнитьРеквизитыШапкиРегл(РеквизитыШапки);
	
	РеквизитыТЧ    = "Номенклатура, СтатьяЗатрат, СчетЗатрат";
	
	Если ТипСтоимости = Перечисления.ВидыНормативнойСтоимостиПроизводства.Фиксированная Тогда
		РеквизитыТЧ = РеквизитыТЧ + ", Сумма";
	Иначе
		РеквизитыТЧ = РеквизитыТЧ + ", Количество, ЕдиницаИзмерения";
	КонецЕсли;
     
	ПроверитьЗаполнениеСубконтоТабличнойЧастиСоставРегл(Отказ, Заголовок, СтруктураШапкиДокумента);
	
	УправлениеЗатратами.НепроверятьРеквизитыПоТипуУчета(ЭтотОбъект, РеквизитыШапки, СтруктураШапкиДокумента, мСтрокаРеквизитыУпрУчета, мСтрокаРеквизитыБухУчета );
	УправлениеЗатратами.НепроверятьРеквизитыПоТипуУчета(ЭтотОбъект, РеквизитыТЧ,    СтруктураШапкиДокумента, мСтрокаРеквизитыУпрУчета, мСтрокаРеквизитыБухУчета, "Материалы");
	
	ЗаполнениеДокументов.ПроверитьЗаполнениеШапкиДокумента(ЭтотОбъект, Новый Структура(РеквизитыШапки), Отказ, Заголовок);
	ЗаполнениеДокументов.ПроверитьЗаполнениеТабличнойЧасти(ЭтотОбъект, "Материалы", Новый Структура(РеквизитыТЧ), Отказ, Заголовок);
	
	// Проверим соответствие подразделения и организации.
	УправлениеЗатратами.ПроверитьПодразделениеОрганизации(ЭтотОбъект, Отказ, Заголовок);
	
	УправлениеЗапасами.ПроверитьЧтоНетНаборов(ЭтотОбъект, "Материалы", , Отказ, Заголовок);

	Если СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете Тогда
		СписСчетовБух = УправлениеПроизводством.ПолучитьЗатратныеСчета("Бух");
		Если Не СписСчетовБух.НайтиПоЗначению(СчетКт) = Неопределено Тогда
			ОбщегоНазначения.СообщитьОбОшибке("Нельзя указывать счет " + СчетКт + " в качестве корреспонденции! (счет бух. учета)", Отказ, Заголовок);
		КонецЕсли;
	КонецЕсли;
	
	// Проверим заполнение налоговых реквизитов
	Если СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете Тогда
		Для Каждого Строка Из Материалы Цикл
			Если СтруктураШапкиДокумента.ЕстьНалогНаПрибыль
				 ИЛИ СтруктураШапкиДокумента.ЕстьНДС Тогда
				Если НЕ ЗначениеЗаполнено(Строка.НалоговоеНазначение) Тогда
					ОбщегоНазначения.СообщитьОбОшибке("Не указано налоговое назначение (строка № " + Строка.НомерСтроки + " таблица ""Номенклатура"")", Отказ, Заголовок);
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
	НалоговыйУчет.ПроверитьЗаполнениеНалоговыхНазначений(
		СтруктураШапкиДокумента, 
		Неопределено,      // Неопределено - в случае проверки шапки документа
		Неопределено,      // Неопределено - в случае проверки шапки документа
		Отказ, 
		Заголовок, 
		"ОтражениеЗатрат", // ВидОперации
		Истина,            // ОтражатьПоЗатратам,
		"СчетКт",          // ИмяРеквизитаСчетЗатрат
		"СубконтоКт"       // ИмяРеквизитаСубконтоЗатрат
	);
	
	НалоговыйУчет.ПроверитьЗаполнениеНалоговыхНазначений(
		СтруктураШапкиДокумента, 
		Материалы.Выгрузить(),
		"Материалы",
		Отказ, 
		Заголовок, 
		"Производство"
	);	
	
	
КонецПроцедуры // ПроверкаРеквизитов()

// Процедура дополняет список реквизитов шапки упр. реквизитами
//
Процедура ДополнитьРеквизитыШапкиУпр(Реквизиты)
	Реквизиты = Реквизиты + ?(ПустаяСтрока(Реквизиты),"",", ") 
	          + "Подразделение";
КонецПроцедуры // ДополнитьРеквизитыШапкиУпр()

// Процедура дополняет список реквизитов шапки регл. реквизитами
//
Процедура ДополнитьРеквизитыШапкиРегл(Реквизиты)
	Реквизиты = Реквизиты + ?(ПустаяСтрока(Реквизиты),"",", ") 
	          + "ПодразделениеОрганизации, СчетКт";
КонецПроцедуры // ДополнитьРеквизитыШапкиРегл()

// Процедура проверяет заполнение регл. реквизитов табличной части Получатели
//
Процедура ПроверитьЗаполнениеСубконтоТабличнойЧастиСоставРегл(Отказ, Заголовок, СтруктураШапкиДокумента)
	
	Если СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете Тогда
		СтруктураПараметров = Новый Структура("СчетКт, СубконтоКт1, СубконтоКт2, СубконтоКт3",
			"Не выбран счет кредита",
			"Не указано субконто 1 кредита счета",
			"Не указано субконто 2 кредита счета",
			"Не указано субконто 3 кредита счета");
		УправлениеЗатратами.ПроверитьЗаполнениеСубконто(ЭтотОбъект, СтруктураПараметров,, Отказ, Заголовок);
		
	КонецЕсли;
	
КонецПроцедуры // ПроверитьЗаполнениеСубконтоТабличнойЧастиСоставРегл()

// Производит заполнение и установку необходимых полей при изменении номенклатуры в табличной части.
//
Процедура ПриИзмененииНоменклатурыМатериалов(СтрокаТабличнойЧасти) Экспорт

	СтрокаТабличнойЧасти.ЕдиницаИзмерения 		= СтрокаТабличнойЧасти.Номенклатура.ЕдиницаХраненияОстатков;
	СтрокаТабличнойЧасти.Коэффициент      		= СтрокаТабличнойЧасти.ЕдиницаИзмерения.Коэффициент;
	ОбработкаТабличныхЧастей.ЗаполнитьЕдиницуМестТабЧасти(СтрокаТабличнойЧасти, ЭтотОбъект, Ложь);
	
КонецПроцедуры // ПриИзмененииНоменклатурыМатериалов()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ДЛЯ ОБЕСПЕЧЕНИЯ ПРОВЕДЕНИЯ ДОКУМЕНТА

// Процедура определяет параметры учетной политики
//
Процедура ПодготовитьПараметрыУчетнойПолитики(СтруктураШапкиДокумента, Отказ, Заголовок)

	мУчетнаяПолитика = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиУпр(Дата);
	Если НЕ ЗначениеЗаполнено(мУчетнаяПолитика) Тогда
		Отказ = Истина;
	КонецЕсли;
	
	Если СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете Тогда
		ПодготовитьПараметрыУчетнойПолитикиРегл(Отказ, Заголовок);
	КонецЕсли;
	
КонецПроцедуры // ПодготовитьПараметрыУчетнойПолитики()

// Процедура определяет параметры регл. учетной политики
//
Процедура ПодготовитьПараметрыУчетнойПолитикиРегл(Отказ, Заголовок)

	мУчетнаяПолитикаРегл = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиРегл(Дата, Организация);
	Если НЕ ЗначениеЗаполнено(мУчетнаяПолитикаРегл) Тогда
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры // ПодготовитьПараметрыУчетнойПолитикиРегл()

// По результату запроса по шапке документа формируем движения по регистрам.
//
// Параметры: 
//  РежимПроведения           - режим проведения документа (оперативный или неоперативный),
//  СтруктураШапкиДокумента   - выборка из результата запроса по шапке документа,
//  ТаблицаПоТоварам          - таблица значений, содержащая данные для проведения и проверки ТЧ Товары
//  ТаблицаПоТаре             - таблица значений, содержащая данные для проведения и проверки ТЧ "Возвратная тара",
//  Отказ                     - флаг отказа в проведении,
//  Заголовок                 - строка, заголовок сообщения об ошибке проведения.
//
Процедура ДвиженияПоРегистрам(РежимПроведения, СтруктураШапкиДокумента, Отказ, Заголовок)
	
	// Формирование движений по регистрам "Затраты на выпуск продукции".				
	УправлениеПроизводствомДвиженияПоРегистрам.СформироватьДвиженияПоРегиструЗатратыНаВыпускПродукции(
		СтруктураШапкиДокумента, 
		"ОприходованиеНЗП",
		мУчетнаяПолитика,
		мУчетнаяПолитикаРегл
		);
	
	// Формирование движений по регистрам "Выпуск продукции" и направлениям выпуска.
	УправлениеПроизводствомДвиженияПоРегистрам.СформироватьДвиженияПоВыпускуПродукцииИНаправлениямВыпуска(
		СтруктураШапкиДокумента, 
		"ОприходованиеНЗП",
		мУчетнаяПолитика, 
		мУчетнаяПолитикаРегл
		);

КонецПроцедуры // ДвиженияПоРегистрам()

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

// Процедура - обработчик события "ОбработкаПроведения".
//
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Если мУдалятьДвижения Тогда
		ОбщегоНазначения.УдалитьДвиженияРегистратора(ЭтотОбъект, Отказ);
	КонецЕсли;

	Заголовок = ОбщегоНазначения.ПредставлениеДокументаПриПроведении(Ссылка);
	СтруктураШапкиДокумента = ОбщегоНазначения.СформироватьСтруктуруШапкиДокумента(ЭтотОбъект);
	ПодготовитьПараметрыУчетнойПолитики(СтруктураШапкиДокумента, Отказ, Заголовок);
		
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	ПроверкаРеквизитов(Отказ, Заголовок, СтруктураШапкиДокумента);
		
	// Движения по документу.
	Если Не Отказ Тогда
		ДвиженияПоРегистрам(РежимПроведения, СтруктураШапкиДокумента, Отказ, Заголовок);
	КонецЕсли;
	
КонецПроцедуры	// ОбработкаПроведения()

// Процедура - обработчик события "ОбработкаЗаполнения".
//
Процедура ОбработкаЗаполнения(Основание)
	
	Если ТипЗнч(Основание) = Тип("ДокументСсылка.ИнвентаризацияНЗП") Тогда
		
		// Заполнение шапки
		Организация                  = Основание.Организация;
		ОтражатьВБухгалтерскомУчете  = Основание.ОтражатьВБухгалтерскомУчете;
		ОтражатьВУправленческомУчете = Основание.ОтражатьВУправленческомУчете;
		Подразделение                = Основание.Подразделение;
		ПодразделениеОрганизации     = Основание.ПодразделениеОрганизации;
		ДокИнвентаризация            = Основание.Ссылка;
		ТипСтоимости                 = Перечисления.ВидыНормативнойСтоимостиПроизводства.Фиксированная;
		Дата						 = ОбщегоНазначения.ПолучитьРабочуюДату();;
		
		УправлениеПроизводством.ЗаполнитьМатериалыПоИнвентаризацииНЗП(ЭтотОбъект, Материалы, ДокИнвентаризация, Истина);
		
	КонецЕсли;
	
КонецПроцедуры // ОбработкаЗаполнения()

// Процедура - обработчик события "ПередЗаписью".
//
Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	Если ОтражатьВБухгалтерскомУчете Тогда
		
		НалоговыйУчет.ЗаполнитьНалоговыеНазначенияВШапкеПередЗаписьюДокумента(
			ЭтотОбъект,
			"СчетКт",    // ИмяРеквизитаСчетЗатрат
			"СубконтоКт" // ИмяРеквизитаСубконто
		);
		
		НалоговыйУчет.ЗаполнитьНалоговыеНазначенияВТабличныхЧастяхПередЗаписьюДокумента(
			"Поступление",
			Дата,
			Организация,
			Материалы,		// ТабличнаяЧастьТовары
			Неопределено,	// ТабличнаяЧастьВозвратнаяТара
			Неопределено,   // ТабличнаяЧастьУслуги
			Неопределено,   // ТабличнаяЧастьОборудование
			Неопределено, 	// ТабличнаяЧастьОбъектыСтроительства
			Неопределено 	// ТабличнаяЧастьБланкиСтрогогоУчета
		);
	
	КонецЕсли;	
	 
	мУдалятьДвижения = НЕ ЭтоНовый();
	
КонецПроцедуры // ПередЗаписью()

// Процедура - обработчик события "ПриЗаписи".
//
Процедура ПриЗаписи(Отказ)
	
	Если ОбменДанными.Загрузка  Тогда
		Возврат;
	КонецЕсли;

КонецПроцедуры // ПриЗаписи()

// Процедура заполняет счета учета по бухгалтерскому и налоговому учету.
//
Процедура ЗаполнитьСчетаУчетаВСтрокеТабЧастиРегл(СтрокаТЧ, ИмяТабЧасти, ЗаполнятьБУ) Экспорт
	
	СчетаУчета = СчетаУчетаВДокументах.ПолучитьСчетаУчетаНоменклатурыИзНастроек(Организация, СтрокаТЧ.Номенклатура, , Дата);
	Если ЗаполнятьБУ = Истина Тогда
		СтрокаТЧ.НалоговоеНазначение = СчетаУчета.НалоговоеНазначение;
	ИначеЕсли ЗаполнятьБУ = Ложь Тогда
		СтрокаТЧ.НалоговоеНазначение = Справочники.НалоговыеНазначенияАктивовИЗатрат.ПустаяСсылка();		
	КонецЕсли;     	
		
КонецПроцедуры // ЗаполнитьСчетаУчетаВСтрокеТабЧасти()

мВалютаРегламентированногоУчета = глЗначениеПеременной("ВалютаРегламентированногоУчета");
мВалютаУправленческогоУчета     = глЗначениеПеременной("ВалютаУправленческогоУчета");

