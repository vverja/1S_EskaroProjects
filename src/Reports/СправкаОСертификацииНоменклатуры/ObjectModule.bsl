#Если Клиент Тогда
// Процедура заполняет данными поле табличного документа отчета
//
// Параметры
//  ДокументРезультат - поле табличного документа
//
// Возвращаемое значение
//  НЕТ
//
Процедура СформироватьОтчет(ДокументРезультат, ПоказатьЗаголовок = Ложь,ВысотаЗаголовка = 0,ТолькоЗаголовок = Ложь) Экспорт
	Перем СтСерия;
	
	Фильтр = "";
	ТекстЗапроса_ОтчетПроизводстваЗаСмену = "";
	Если Метаданные.Документы.Найти("ОтчетПроизводстваЗаСмену") <> Неопределено Тогда
		ТекстЗапроса_ОтчетПроизводстваЗаСмену = "
			|			ОБЪЕДИНИТЬ
			|			
			|			ВЫБРАТЬ
			|				ОтчетПроизводстваЗаСменуПродукция.Количество,
			|				ОтчетПроизводстваЗаСменуПродукция.СерияНоменклатуры
			|			ИЗ
			|				Документ.ОтчетПроизводстваЗаСмену.Продукция КАК ОтчетПроизводстваЗаСменуПродукция,
			|				Документ.ОтчетПроизводстваЗаСмену КАК ОтчетПроизводстваЗаСмену
			|			ГДЕ
			|				ОтчетПроизводстваЗаСмену.Ссылка = ОтчетПроизводстваЗаСменуПродукция.Ссылка
			|				И ОтчетПроизводстваЗаСмену.Проведен
			|				И ОтчетПроизводстваЗаСмену.ОтражатьВУправленческомУчете
			|";
	КонецЕсли;
	
	Если Внешняя И Внутренняя Тогда
		
		Если ЗначениеЗаполнено(Номенклатура) Тогда
			Фильтр = " ГДЕ Ном В ИЕРАРХИИ (&Номенклатура) И Ном ЕСТЬ НЕ NULL";
		КонецЕсли; 
		Запрос=Новый Запрос;
		ТекстЗапроса =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Итог.Ном,
		|	ВЫБОР
		|		КОГДА Итог.Серия ЕСТЬ NULL 
		|			ТОГДА ""<Пустая серия>""
		|		ИНАЧЕ Итог.Серия
		|	КОНЕЦ КАК Серия,
		|	Итог.Количество КАК РзмерПартии,
		|	Итог.ДокЗаявки,
		|	Итог.ДокСерт,
		|	Итог.ДокОтказ,
		|	Итог.ДокОтбора,
		|	Итог.СрокГодности,
		|	Итог.НомерСертификата
		|ИЗ
		|	(ВЫБРАТЬ
		|		РегСертификация.Ном КАК Ном,
		|		РегСертификация.Серия КАК Серия,
		|		РегСертификация.Сертификация КАК Сертификация,
		|		РегСертификация.ДатаСертификата КАК ДатаСертификата,
		|		РегСертификация.НомерСертификата КАК НомерСертификата,
		|		РегСертификация.ДокОтказ КАК ДокОтказ,
		|		РегСертификация.ДокОтбора КАК ДокОтбора,
		|		РегСертификация.ДокЗаявки КАК ДокЗаявки,
		|		РегСертификация.ДокСерт КАК ДокСерт,
		|		РегСертификация.СрокГодности КАК СрокГодности,
		|		РазмерПартии.Количество КАК Количество,
		|		РазмерПартии.Серия КАК Серия1
		|	ИЗ
		|		(ВЫБРАТЬ
		|			РегВнешнСертификация.СерияНоменклатуры.Владелец КАК Ном,
		|			РегВнешнСертификация.СерияНоменклатуры КАК Серия,
		|			РегВнешнСертификация.СостояниеСертификации КАК Сертификация,
		|			РегВнешнСертификация.ДатаСертификата КАК ДатаСертификата,
		|			РегВнешнСертификация.НомерСертификата КАК НомерСертификата,
		|			ВЫБОР
		|				КОГДА РегВнешнСертификация.СостояниеСертификации = &ВидСертификацииОтказ
		|					ТОГДА РегВнешнСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокОтказ,
		|			ВЫБОР
		|				КОГДА РегВнешнСертификация.СостояниеСертификации = &ВидСертификацииОтбор
		|					ТОГДА РегВнешнСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокОтбора,
		|			ВЫБОР
		|				КОГДА РегВнешнСертификация.СостояниеСертификации = &ВидСертификацииЗаявка
		|					ТОГДА РегВнешнСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокЗаявки,
		|			ВЫБОР
		|				КОГДА РегВнешнСертификация.СостояниеСертификации = &ВидСертификацииСерт
		|					ТОГДА РегВнешнСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокСерт,
		|			РегВнешнСертификация.Регистратор.СрокГодностиСертификата КАК СрокГодности
		|		ИЗ
		|			РегистрСведений.СертификацияНоменклатуры КАК РегВнешнСертификация
		|		ГДЕ
		|			РегВнешнСертификация.ВидСертификата = &ВнешнСертификат
		|			И РегВнешнСертификация.Период >= &ДатаНач
		|			И РегВнешнСертификация.Период <= &ДатаКон
		|			И (РегВнешнСертификация.Регистратор.ВидОперации = &ВидОперации
		|					ИЛИ РегВнешнСертификация.Регистратор.ВидОперации = &ВидОперацииЗаявки
		|					ИЛИ РегВнешнСертификация.Регистратор.ВидОперации = &ВидыОперацийАктОтбораПробНоменклатуры
		|					ИЛИ РегВнешнСертификация.Регистратор = НЕОПРЕДЕЛЕНО)) КАК РегСертификация
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				ПоступлениеТоваровУслугТовары.Количество КАК Количество,
		|				ПоступлениеТоваровУслугТовары.СерияНоменклатуры КАК Серия
		|			ИЗ
		|				Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары,
		|				Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
		|			ГДЕ
		|				ПоступлениеТоваровУслуг.Ссылка = ПоступлениеТоваровУслугТовары.Ссылка
		|				И ПоступлениеТоваровУслуг.Проведен
		|				И ПоступлениеТоваровУслуг.ОтражатьВУправленческомУчете
		|				И ПоступлениеТоваровУслуг.ВидОперации = &прмВидОперации
		|" + ТекстЗапроса_ОтчетПроизводстваЗаСмену + ") КАК РазмерПартии
		|			ПО РазмерПартии.Серия = РегСертификация.Серия) КАК Итог
		|"
		+Фильтр+"
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Итог.Ном,
		|	ВЫБОР
		|		КОГДА Итог.Серия ЕСТЬ NULL 
		|			ТОГДА ""<Пустая серия>""
		|		ИНАЧЕ Итог.Серия
		|	КОНЕЦ,
		|	Итог.Количество,
		|	Итог.ДокЗаявки,
		|	Итог.ДокСерт,
		|	Итог.ДокОтказ,
		|	Итог.ДокОтбора,
		|	""ПусСрокГодн"",
		|	""ПусНомСерт""
		|ИЗ
		|	(ВЫБРАТЬ
		|		РегСертификация.Ном КАК Ном,
		|		РегСертификация.Серия КАК Серия,
		|		РегСертификация.Сертификация КАК Сертификация,
		|		РегСертификация.Контрагент КАК Контрагент,
		|		РегСертификация.ДокОтказ КАК ДокОтказ,
		|		РегСертификация.ДокОтбора КАК ДокОтбора,
		|		РегСертификация.ДокЗаявки КАК ДокЗаявки,
		|		РегСертификация.ДокСерт КАК ДокСерт,
		|		РегСертификация.СрокГодности КАК СрокГодности,
		|		РазмерПартии.Количество КАК Количество,
		|		РазмерПартии.Серия КАК Серия1
		|	ИЗ
		|		(ВЫБРАТЬ
		|			РегВнутрСертификация.СерияНоменклатуры.Владелец КАК Ном,
		|			РегВнутрСертификация.СерияНоменклатуры КАК Серия,
		|			РегВнутрСертификация.СостояниеСертификации КАК Сертификация,
		|			РегВнутрСертификация.Регистратор.ОрганПоСертификации КАК Контрагент,
		|			ВЫБОР
		|				КОГДА РегВнутрСертификация.СостояниеСертификации = &ВидСертификацииОтказ
		|					ТОГДА РегВнутрСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокОтказ,
		|			ВЫБОР
		|				КОГДА РегВнутрСертификация.СостояниеСертификации = &ВидСертификацииОтбор
		|					ТОГДА РегВнутрСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокОтбора,
		|			ВЫБОР
		|				КОГДА РегВнутрСертификация.СостояниеСертификации = &ВидСертификацииЗаявка
		|					ТОГДА РегВнутрСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокЗаявки,
		|			ВЫБОР
		|				КОГДА РегВнутрСертификация.СостояниеСертификации = &ВидСертификацииСерт
		|					ТОГДА РегВнутрСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокСерт,
		|			РегВнутрСертификация.Регистратор.СрокГодностиСертификата КАК СрокГодности
		|		ИЗ
		|			РегистрСведений.СертификацияНоменклатуры КАК РегВнутрСертификация
		|		ГДЕ
		|			РегВнутрСертификация.ВидСертификата = &ВнутрСертификат
		|			И РегВнутрСертификация.Период >= &ДатаНач
		|			И РегВнутрСертификация.Период <= &ДатаКон
		|			И (РегВнутрСертификация.Регистратор.ВидОперации = &ВидОперацииВнут
		|					ИЛИ РегВнутрСертификация.Регистратор.ВидОперации = &ВидОперацииЗаявкиВнут
		|					ИЛИ РегВнутрСертификация.Регистратор.ВидОперации = &ВидыОперацийАктОтбораПробВнут
		|					ИЛИ РегВнутрСертификация.Регистратор = НЕОПРЕДЕЛЕНО)) КАК РегСертификация
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				ПоступлениеТоваровУслугТовары.Количество КАК Количество,
		|				ПоступлениеТоваровУслугТовары.СерияНоменклатуры КАК Серия
		|			ИЗ
		|				Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары,
		|				Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
		|			ГДЕ
		|				ПоступлениеТоваровУслуг.Ссылка = ПоступлениеТоваровУслугТовары.Ссылка
		|				И ПоступлениеТоваровУслуг.Проведен
		|				И ПоступлениеТоваровУслуг.ОтражатьВУправленческомУчете
		|				И ПоступлениеТоваровУслуг.ВидОперации = &прмВидОперации
		|" + ТекстЗапроса_ОтчетПроизводстваЗаСмену + ") КАК РазмерПартии
		|			ПО РазмерПартии.Серия = РегСертификация.Серия) КАК Итог
		|"
		+Фильтр+"
		|";
		Запрос.Текст = ТекстЗапроса;
		Запрос.УстановитьПараметр( "ДатаНач",        НачалоДня( ДатаНач));
		Запрос.УстановитьПараметр( "ДатаКон",        КонецДня ( ДатаКон));
		Запрос.УстановитьПараметр( "прмВидОперации", Перечисления.ВидыОперацийПоступлениеТоваровУслуг.ПокупкаКомиссия);
		
		Запрос.УстановитьПараметр( "ВидСертификацииЗаявка", Перечисления.СостоянияСертификацииНоменклатуры.Заявка);
		Запрос.УстановитьПараметр( "ВидСертификацииСерт",   Перечисления.СостоянияСертификацииНоменклатуры.Есть);
		Запрос.УстановитьПараметр( "ВидСертификацииОтбор",  Перечисления.СостоянияСертификацииНоменклатуры.ОтборПроб);
		Запрос.УстановитьПараметр( "ВидСертификацииОтказ",  Перечисления.СостоянияСертификацииНоменклатуры.Отказ);
		
		Запрос.УстановитьПараметр( "ВнешнСертификат",       Перечисления.ВидыСертификацииНоменклатуры.ВнешняяСертификация);
		Запрос.УстановитьПараметр( "ВнутрСертификат",       Перечисления.ВидыСертификацииНоменклатуры.ВнутренняяСертификация);
		
		Запрос.УстановитьПараметр( "Номенклатура",                          Номенклатура);
		Запрос.УстановитьПараметр( "ВидОперации",                           Перечисления.ВидыОперацийСертификацияНоменклатуры.Внешняя);
		Запрос.УстановитьПараметр( "ВидОперацииЗаявки",                     Перечисления.ВидыОперацийЗаявкаНаСертификациюНоменклатуры.Внешняя);
		Запрос.УстановитьПараметр( "ВидыОперацийАктОтбораПробНоменклатуры", Перечисления.ВидыОперацийАктОтбораПробНоменклатуры.ДляВнешнейСертификации);
		
		Запрос.УстановитьПараметр( "ВидОперацииВнут",               Перечисления.ВидыОперацийСертификацияНоменклатуры.внутренняя);
		Запрос.УстановитьПараметр( "ВидОперацииЗаявкиВнут",         Перечисления.ВидыОперацийЗаявкаНаСертификациюНоменклатуры.внутренняя);
		Запрос.УстановитьПараметр( "ВидыОперацийАктОтбораПробВнут", Перечисления.ВидыОперацийАктОтбораПробНоменклатуры.ДляВнутреннейСертификации);
		
		ТЗ=Запрос.Выполнить().Выгрузить();
		ТЗ.Сортировать("Ном, Серия");
		
		ТЗНом = ТЗ.Скопировать();
		
		ТЗНом.Свернуть("Ном");
		
		ТабРеультатов = Новый ТаблицаЗначений;
		ТабРеультатов.Колонки.Добавить("Номенклатура");
		ТабРеультатов.Колонки.Добавить("Количество");	
		ТабРеультатов.Колонки.Добавить("Серия"); 
		ТабРеультатов.Колонки.Добавить("ДокОтказ"); 
		ТабРеультатов.Колонки.Добавить("ДатаОтказ"); 
		
		ТабРеультатов.Колонки.Добавить("ДокЗаявки"); 
		ТабРеультатов.Колонки.Добавить("ДатаЗаявки"); 
		ТабРеультатов.Колонки.Добавить("ДокПроба"); 
		ТабРеультатов.Колонки.Добавить("ДатаПробы"); 
		ТабРеультатов.Колонки.Добавить("ДокСерт"); 
		ТабРеультатов.Колонки.Добавить("ДатаСерт"); 
		ТабРеультатов.Колонки.Добавить("НомСерт"); 
		ТабРеультатов.Колонки.Добавить("СрокСерт");
		ТабРеультатов.Колонки.Добавить("ПериодСерт");
		
		ТабРеультатов.Колонки.Добавить("ДокОтказВнут"); 
		ТабРеультатов.Колонки.Добавить("ДатаОтказВнут"); 
		ТабРеультатов.Колонки.Добавить("ДокЗаявкиВнут"); 
		ТабРеультатов.Колонки.Добавить("ДатаЗаявкиВнут"); 
		ТабРеультатов.Колонки.Добавить("ДокПробаВнут"); 
		ТабРеультатов.Колонки.Добавить("ДатаПробыВнут"); 
		ТабРеультатов.Колонки.Добавить("ДокСертВнут"); 
		ТабРеультатов.Колонки.Добавить("ДатаСертВнут"); 
		ТабРеультатов.Колонки.Добавить("ПериодСертВнут");
		
		ТабЗаявки = Новый ТаблицаЗначений;
		ТабЗаявки.Колонки.Добавить("Док");
		
		ТабОтказ = Новый ТаблицаЗначений;
		ТабОтказ.Колонки.Добавить("Док");
		
		
		ТабСерт = Новый ТаблицаЗначений;
		ТабСерт.Колонки.Добавить("Док");
		
		ТабПробы = Новый ТаблицаЗначений;
		ТабПробы.Колонки.Добавить("Док");
		
		ТабОтказВнут = Новый ТаблицаЗначений;
		ТабОтказВнут.Колонки.Добавить("Док");
		
		ТабЗаявкиВнут = Новый ТаблицаЗначений;
		ТабЗаявкиВнут.Колонки.Добавить("Док");
		
		ТабСертВнут = Новый ТаблицаЗначений;
		ТабСертВнут.Колонки.Добавить("Док");
		
		ТабПробыВнут = Новый ТаблицаЗначений;
		ТабПробыВнут.Колонки.Добавить("Док");
		
		Для каждого СтрокаНоменклатуры Из ТЗНом Цикл
			
			Ном = СтрокаНоменклатуры.Ном;
			Структ = Новый Структура;
			Структ.Вставить("Ном",Ном);
			
			Серия ="";
			Строки = ТЗ.НайтиСтроки(Структ);
			Колич = 0;
			МинДатаЗаявки = "";
			МинДатаСерт = "";
			СтСерт = "";
			СтОтказ = "";
			СтЗаявки = "";
			СтПробы = "";
			СрокГодности = "";
			НомерСертификата = "";
			ТабЗаявки.Очистить();
			ТабПробы.Очистить();
			ТабСерт.Очистить();
			ТабОтказ.Очистить();
			СтОтказВнут = "";
			СтСертВнут = "";
			СтЗаявкиВнут = "";
			СтПробыВнут = "";
			МинДатаЗаявкиВнут = "";
			МинДатаСертВнут = "";
			
			ТабЗаявкиВнут.Очистить();
			ТабПробыВнут.Очистить();
			ТабСертВнут.Очистить();
			ТабОтказВнут.Очистить();
			
			Если Строки.Количество() > 0 Тогда
				//Тут все серии по данной Номенклатуре 
				Для каждого Строка Из Строки Цикл
					
					Если Серия <> Строка.Серия и Серия <> "" Тогда
						
						Если МинДатаСерт <> "" и МинДатаЗаявки <> "" и МинДатаСерт >= МинДатаЗаявки Тогда
							ПерСерт = 1 + (НачалоДня(МинДатаСерт) - НачалоДня(МинДатаЗаявки)) / 86400;	
						Иначе	
							ПерСерт = 0;
						КонецЕсли; 
						
						
						Если МинДатаСертВнут <> "" и МинДатаЗаявкиВнут <> "" и МинДатаСертВнут >= МинДатаЗаявкиВнут Тогда
							ПерСертВнут = 1 + (НачалоДня(МинДатаСертВнут) - НачалоДня(МинДатаЗаявкиВнут)) / 86400;	
						Иначе	
							ПерСертВнут = 0;
						КонецЕсли; 
						
						СтрокаРезультатов = ТабРеультатов.Добавить();
						СтрокаРезультатов.Номенклатура = Ном; 
						СтрокаРезультатов.Серия = Серия; 
						СтрокаРезультатов.ДокЗаявки = ТабЗаявки.Скопировать(); 
						СтрокаРезультатов.ДатаЗаявки = СтЗаявки; 
						СтрокаРезультатов.ДокПроба = ТабПробы.Скопировать(); 
						СтрокаРезультатов.ДатаПробы = СтПробы; 
						СтрокаРезультатов.ДокОтказ = ТабОтказ.Скопировать(); 
						СтрокаРезультатов.ДатаОтказ = СтОтказ; 
						
						СтрокаРезультатов.ДокСерт = ТабСерт.Скопировать(); 
						СтрокаРезультатов.ДатаСерт = СтСерт; 
						СтрокаРезультатов.НомСерт = НомерСертификата; 
						СтрокаРезультатов.СрокСерт = СрокГодности;
						СтрокаРезультатов.ПериодСерт = ПерСерт;
						СтрокаРезультатов.Количество = Колич;
						
						СтрокаРезультатов.ДокОтказВнут = ТабОтказВнут.Скопировать(); 
						СтрокаРезультатов.ДатаОтказВнут = СтОтказВнут; 
						СтрокаРезультатов.ДокЗаявкиВнут = ТабЗаявкиВнут.Скопировать(); 
						СтрокаРезультатов.ДатаЗаявкиВнут = СтЗаявкиВнут; 
						СтрокаРезультатов.ДокПробаВнут = ТабПробыВнут.Скопировать(); 
						СтрокаРезультатов.ДатаПробыВнут = СтПробыВнут; 
						СтрокаРезультатов.ДокСертВнут = ТабСертВнут.Скопировать(); 
						СтрокаРезультатов.ДатаСертВнут = СтСертВнут; 
						СтрокаРезультатов.ПериодСертВнут = ПерСертВнут;
						
						Колич = 0;
						МинДатаЗаявки = "";
						МинДатаСерт = "";
						МинДатаЗаявкиВнут = "";
						МинДатаСертВнут = "";
						
						СтСерт = "";
						СтОтказ = "";
						СтЗаявки = "";
						СтПробы = "";
						
						СтОтказВнут = "";
						СтСертВнут = "";
						СтЗаявкиВнут = "";
						СтПробыВнут = "";
						
						СрокГодности = "";
						НомерСертификата = "";
						ТабЗаявки.Очистить();
						ТабПробы.Очистить();
						ТабСерт.Очистить();
						ТабОтказ.Очистить();
						ТабЗаявкиВнут.Очистить();
						ТабПробыВнут.Очистить();
						ТабСертВнут.Очистить();
						ТабОтказВнут.Очистить();
					КонецЕсли;	
					
					Серия = Строка.Серия;
					ДокЗаявки = Строка.ДокЗаявки;
					ДокСерт = Строка.ДокСерт;
					ДокПробы = Строка.ДокОтбора;
					ДокОтказ = Строка.ДокОтказ;
					
					Если Строка.НомерСертификата = "ПусНомСерт" Тогда
						
						Если Колич = 0 и Строка.РзмерПартии <> Null Тогда
							Колич = Строка.РзмерПартии;
						КонецЕсли;	
						
						Если ДокЗаявки <> Null Тогда
							Если МинДатаЗаявкиВнут = "" Тогда
								МинДатаЗаявкиВнут = ДокЗаявки.Дата;
							КонецЕсли; 
							
							Если МинДатаЗаявкиВнут > ДокЗаявки.Дата Тогда
								МинДатаЗаявкиВнут = ДокЗаявки.Дата;					
							КонецЕсли; 
						КонецЕсли; 
						
						Если ДокЗаявки <> Null Тогда
							ДатаЗаявки = Формат(ДокЗаявки.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтЗаявкиВнут,ДатаЗаявки) = 0 Тогда
								СтЗаявкиВнут = ?(СтЗаявкиВнут = "",СтЗаявкиВнут,СтЗаявкиВнут + Символы.ПС) + ДатаЗаявки;
							КонецЕсли; 
							СтрокаЗаявки = ТабЗаявкиВнут.Найти(ДокЗаявки.Ссылка,"Док");
							Если СтрокаЗаявки = Неопределено Тогда
								СтрокаЗаявки = ТабЗаявкиВнут.Добавить();
								СтрокаЗаявки.Док = ДокЗаявки.Ссылка;
							КонецЕсли; 
						КонецЕсли;
						
						Если ДокСерт <> Null Тогда
							
							Если МинДатаСертВнут = "" Тогда
								МинДатаСертВнут = ДокСерт.Дата;
							КонецЕсли; 
							
							Если МинДатаСертВнут > ДокСерт.Дата Тогда
								МинДатаСертВнут = ДокСерт.Дата;					
							КонецЕсли; 
						КонецЕсли; 
						
						Если ДокСерт <> Null Тогда
							ДатаСерт = Формат(ДокСерт.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтСертВнут,ДатаСерт) = 0 Тогда
								СтСертВнут = ?(СтСертВнут = "",СтСертВнут,СтСертВнут + Символы.ПС) + ДатаСерт;
							КонецЕсли; 
							СтрокаСерт = ТабСертВнут.Найти(ДокСерт.Ссылка,"Док");
							Если СтрокаСерт = Неопределено Тогда
								СтрокаСерт = ТабСертВнут.Добавить();
								СтрокаСерт.Док = ДокСерт.Ссылка;
							КонецЕсли; 
						КонецЕсли;
						
						Если ДокОтказ <> Null Тогда
							ДатаОтказ = Формат(ДокОтказ.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтОтказВнут,ДатаОтказ) = 0 Тогда
								СтОтказВнут = ?(СтОтказВнут = "",СтОтказВнут,СтОтказВнут + Символы.ПС) + ДатаОтказ;
							КонецЕсли; 
							СтрокаОтказ = ТабОтказВнут.Найти(ДокОтказ.Ссылка,"Док");
							Если СтрокаОтказ = Неопределено Тогда
								СтрокаОтказ = ТабОтказВнут.Добавить();
								СтрокаОтказ.Док = ДокОтказ.Ссылка;
							КонецЕсли; 
						КонецЕсли;
						
						Если ДокПробы <> Null Тогда
							ДатаПробы = Формат(ДокПробы.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтПробыВнут,ДатаПробы) = 0 Тогда
								СтПробыВнут = ?(СтПробыВнут = "",СтПробыВнут,СтПробыВнут + Символы.ПС) + ДатаПробы;
							КонецЕсли; 
							СтрокаПробы = ТабПробыВнут.Найти(ДокПробы.Ссылка,"Док");
							Если СтрокаПробы = Неопределено Тогда
								СтрокаПробы = ТабПробыВнут.Добавить();
								СтрокаПробы.Док = ДокПробы.Ссылка;
							КонецЕсли; 
						КонецЕсли;
					Иначе
						
						Если Строка.СрокГодности <> Null Тогда
							Если Найти(СрокГодности,Формат(Строка.СрокГодности,"ДФ=dd.MM.yyyy")) = 0 Тогда
								СрокГодности = ?(СрокГодности  = "",СрокГодности ,СрокГодности  + Символы.ПС) + Формат(Строка.СрокГодности,"ДФ=dd.MM.yyyy");
							КонецЕсли; 
						КонецЕсли; 
						
						Если Строка.НомерСертификата <> Null Тогда
							Если Найти(НомерСертификата,СокрЛП(Строка.НомерСертификата)) = 0 Тогда
								НомерСертификата = ?(НомерСертификата = "",НомерСертификата,НомерСертификата + Символы.ПС) + СокрЛП(Строка.НомерСертификата);
							КонецЕсли; 
						КонецЕсли; 
						
						Если Колич = 0 и Строка.РзмерПартии <> Null Тогда
							Колич = Строка.РзмерПартии;
						КонецЕсли;	
						
						Если ДокЗаявки <> Null Тогда
							Если МинДатаЗаявки = "" Тогда
								МинДатаЗаявки = ДокЗаявки.Дата;
							КонецЕсли; 
							
							Если МинДатаЗаявки > ДокЗаявки.Дата Тогда
								МинДатаЗаявки = ДокЗаявки.Дата;					
							КонецЕсли; 
						КонецЕсли; 
						
						Если ДокЗаявки <> Null Тогда
							ДатаЗаявки = Формат(ДокЗаявки.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтЗаявки,ДатаЗаявки) = 0 Тогда
								СтЗаявки = ?(СтЗаявки = "",СтЗаявки,СтЗаявки + Символы.ПС) + ДатаЗаявки;
							КонецЕсли; 
							СтрокаЗаявки = ТабЗаявки.Найти(ДокЗаявки.Ссылка,"Док");
							Если СтрокаЗаявки = Неопределено Тогда
								СтрокаЗаявки = ТабЗаявки.Добавить();
								СтрокаЗаявки.Док = ДокЗаявки.Ссылка;
							КонецЕсли; 
						КонецЕсли;
						
						Если ДокСерт <> Null Тогда
							
							Если МинДатаСерт = "" Тогда
								МинДатаСерт = ДокСерт.Дата;
							КонецЕсли; 
							
							Если МинДатаСерт > ДокСерт.Дата Тогда
								МинДатаСерт = ДокСерт.Дата;					
							КонецЕсли; 
						КонецЕсли; 
						
						Если ДокСерт <> Null Тогда
							ДатаСерт = Формат(ДокСерт.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтСерт,ДатаСерт) = 0 Тогда
								СтСерт = ?(СтСерт = "",СтСерт,СтСерт + Символы.ПС) + ДатаСерт;
							КонецЕсли; 
							СтрокаСерт = ТабСерт.Найти(ДокСерт.Ссылка,"Док");
							Если СтрокаСерт = Неопределено Тогда
								СтрокаСерт = ТабСерт.Добавить();
								СтрокаСерт.Док = ДокСерт.Ссылка;
							КонецЕсли; 
						КонецЕсли;
						
						Если ДокОтказ <> Null Тогда
							ДатаОтказ = Формат(ДокОтказ.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтОтказ,ДатаОтказ) = 0 Тогда
								СтОтказ = ?(СтОтказ = "",СтОтказ,СтОтказ + Символы.ПС) + ДатаОтказ;
							КонецЕсли; 
							СтрокаОтказ = ТабОтказ.Найти(ДокОтказ.Ссылка,"Док");
							Если СтрокаОтказ = Неопределено Тогда
								СтрокаОтказ = ТабОтказ.Добавить();
								СтрокаОтказ.Док = ДокОтказ.Ссылка;
							КонецЕсли; 
						КонецЕсли;
						
						Если ДокПробы <> Null Тогда
							ДатаПробы = Формат(ДокПробы.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтПробы,ДатаПробы) = 0 Тогда
								СтПробы = ?(СтПробы = "",СтПробы,СтПробы + Символы.ПС) + ДатаПробы;
							КонецЕсли; 
							СтрокаПробы = ТабПробы.Найти(ДокПробы.Ссылка,"Док");
							Если СтрокаПробы = Неопределено Тогда
								СтрокаПробы = ТабПробы.Добавить();
								СтрокаПробы.Док = ДокПробы.Ссылка;
							КонецЕсли; 
						КонецЕсли;
					КонецЕсли; 
					
				КонецЦикла;  
				
				Если МинДатаСерт <> "" и МинДатаЗаявки <> "" и МинДатаСерт >= МинДатаЗаявки Тогда
					ПерСерт = 1 + (НачалоДня(МинДатаСерт) - НачалоДня(МинДатаЗаявки)) / 86400;	
				Иначе	
					ПерСерт = 0;
				КонецЕсли; 
				
				
				Если МинДатаСертВнут <> "" и МинДатаЗаявкиВнут <> "" и МинДатаСертВнут >= МинДатаЗаявкиВнут Тогда
					ПерСертВнут = 1 + (НачалоДня(МинДатаСертВнут) - НачалоДня(МинДатаЗаявкиВнут)) / 86400;	
				Иначе	
					ПерСертВнут = 0;
				КонецЕсли; 
				
				СтрокаРезультатов = ТабРеультатов.Добавить();
				СтрокаРезультатов.Номенклатура = Ном; 
				СтрокаРезультатов.Серия = Серия; 
				СтрокаРезультатов.ДокЗаявки = ТабЗаявки.Скопировать(); 
				СтрокаРезультатов.ДатаЗаявки = СтЗаявки; 
				СтрокаРезультатов.ДокПроба = ТабПробы.Скопировать(); 
				СтрокаРезультатов.ДатаПробы = СтПробы; 
				СтрокаРезультатов.ДокОтказ = ТабОтказ.Скопировать(); 
				СтрокаРезультатов.ДатаОтказ = СтОтказ; 
				
				СтрокаРезультатов.ДокСерт = ТабСерт.Скопировать(); 
				СтрокаРезультатов.ДатаСерт = СтСерт; 
				СтрокаРезультатов.НомСерт = НомерСертификата; 
				СтрокаРезультатов.СрокСерт = СрокГодности;
				СтрокаРезультатов.ПериодСерт = ПерСерт;
				СтрокаРезультатов.Количество = Колич;
				
				СтрокаРезультатов.ДокОтказВнут = ТабОтказВнут.Скопировать(); 
				СтрокаРезультатов.ДатаОтказВнут = СтОтказВнут; 
				СтрокаРезультатов.ДокЗаявкиВнут = ТабЗаявкиВнут.Скопировать(); 
				СтрокаРезультатов.ДатаЗаявкиВнут = СтЗаявкиВнут; 
				СтрокаРезультатов.ДокПробаВнут = ТабПробыВнут.Скопировать(); 
				СтрокаРезультатов.ДатаПробыВнут = СтПробыВнут; 
				СтрокаРезультатов.ДокСертВнут = ТабСертВнут.Скопировать(); 
				СтрокаРезультатов.ДатаСертВнут = СтСертВнут; 
				СтрокаРезультатов.ПериодСертВнут = ПерСертВнут;
				
			КонецЕсли; 
		КонецЦикла; 
		
		ДокументРезультат.Очистить();
		Макет = ЭтотОбъект.ПолучитьМакет("Сертификация");
		Секция = Макет.ПолучитьОбласть("ШапкаСерт");
		ДокументРезультат.Вывести(Секция);	
		
		СекцияНоменклатуры = Макет.ПолучитьОбласть("СтрокаНоменклатурыСерт");
		Секция = Макет.ПолучитьОбласть("СтрокаСерииСерт");
		
		ДокументРезультат.НачатьАвтогруппировкуСтрок();
		
		ЧислоСертификаций = 0;
		ОбщееКоличествоДней = 0;
		
		ЧислоСертификацийВнут = 0;
		ОбщееКоличествоДнейВнут = 0;
		
		Для каждого Строка Из ТабРеультатов Цикл
			
			Если СекцияНоменклатуры.Параметры.Номенклатура <> Строка.Номенклатура  Тогда
				
				Структ = Новый Структура;
				Структ.Вставить("Номенклатура",Строка.Номенклатура);
				Строки = ТабРеультатов.НайтиСтроки(Структ);	
				СредКол = 0;
				Кол = 0;
				СредКолВнут = 0;
				КолВнут = 0;
				
				Если Строки.Количество()>0 Тогда
					Для каждого СтрокаНом Из Строки Цикл
						СредКол = СредКол + СтрокаНом.ПериодСерт;
						Если СтрокаНом.ПериодСерт <> 0 Тогда
							Кол = Кол + 1;
						КонецЕсли; 
						
						СредКолВнут = СредКолВнут + СтрокаНом.ПериодСертВнут;
						Если СтрокаНом.ПериодСертВнут <> 0 Тогда
							КолВнут = КолВнут + 1;
						КонецЕсли; 
					КонецЦикла; 	
					Если Кол <> 0 Тогда
						СредКол = Окр(СредКол / Кол);
					Иначе
						СредКол = 0;
					КонецЕсли; 
					
					Если КолВнут <> 0 Тогда
						СредКолВнут = Окр(СредКолВнут / КолВнут);
					Иначе
						СредКолВнут = 0;
					КонецЕсли; 
				КонецЕсли; 
				
				СекцияНоменклатуры.Параметры.Номенклатура = Строка.Номенклатура;
				СекцияНоменклатуры.Параметры.ПериодСерт = СредКол;
				СекцияНоменклатуры.Параметры.ПериодСертВнут = СредКолВнут;
				
				ДокументРезультат.Вывести(СекцияНоменклатуры,2);
			КонецЕсли;  	
			
			Секция.Параметры.Заполнить(Строка);	
			ДокументРезультат.Вывести(Секция,3);
			
			ОбщееКоличествоДней = ОбщееКоличествоДней + Строка.ПериодСерт;
			Если Строка.ПериодСерт <> 0 Тогда
				ЧислоСертификаций = ЧислоСертификаций + 1; 
			КонецЕсли;
			
			ОбщееКоличествоДнейВнут = ОбщееКоличествоДнейВнут + Строка.ПериодСертВнут;
			Если Строка.ПериодСертВнут <> 0 Тогда
				ЧислоСертификацийВнут = ЧислоСертификацийВнут + 1; 
			КонецЕсли; 
			
		КонецЦикла;  
		
		ДокументРезультат.ЗакончитьАвтогруппировкуСтрок();
		
		
		Секция=Макет.ПолучитьОбласть("ПодвалСерт");
		Секция.Параметры.ДатаОтчета=Формат(ТекущаяДата(),"ДЛФ=Д");
		Если ЧислоСертификаций<>0 Тогда
			СреднееЧисло=Окр(ОбщееКоличествоДней/ЧислоСертификаций);
		Иначе
			СреднееЧисло="";
		КонецЕсли;
		Секция.Параметры.СреднееЧисло=СреднееЧисло;
		
		Если ЧислоСертификацийВнут<>0 Тогда
			СреднееЧислоВнут=Окр(ОбщееКоличествоДнейВнут/ЧислоСертификацийВнут);
		Иначе
			СреднееЧислоВнут="";
		КонецЕсли;
		Секция.Параметры.СреднееЧислоВнут=СреднееЧислоВнут;
		
		ДокументРезультат.Вывести(Секция);
		
	ИначеЕсли Внешняя Тогда
		
		Если ЗначениеЗаполнено(Контрагент) Тогда
			Фильтр = " ГДЕ Контрагент В ИЕРАРХИИ (&Контрагент)";
		КонецЕсли; 
		
		Если ЗначениеЗаполнено(Контрагент) И ЗначениеЗаполнено(Номенклатура) Тогда
			Фильтр = Фильтр + " И Ном В ИЕРАРХИИ (&Номенклатура) И Ном ЕСТЬ НЕ NULL";
		ИначеЕсли ЗначениеЗаполнено(Номенклатура) Тогда
			Фильтр = " ГДЕ Ном В ИЕРАРХИИ (&Номенклатура) И Ном ЕСТЬ НЕ NULL";
		КонецЕсли; 
		
		Запрос=Новый Запрос;
		ТекстЗапроса = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Итог.Ном,
		|	ВЫБОР
		|		КОГДА Итог.Серия ЕСТЬ NULL 
		|			ТОГДА ""<Пустая серия>""
		|		ИНАЧЕ Итог.Серия
		|	КОНЕЦ КАК Серия,
		|	Итог.Количество КАК РзмерПартии,
		|	Итог.ДокЗаявки,
		|	Итог.ДокСерт,
		|	Итог.ДокОтбора,
		|	Итог.ДокОтказ,
		|	Итог.СрокГодности,
		|	Итог.НомерСертификата,
		|	ВЫБОР
		|		КОГДА Итог.Контрагент ЕСТЬ NULL 
		|				ИЛИ Итог.Контрагент = &ПустойКонтрагент
		|			ТОГДА ""<Пустой ОС>""
		|		ИНАЧЕ Итог.Контрагент
		|	КОНЕЦ КАК Контрагент
		|ИЗ
		|	(ВЫБРАТЬ
		|		РегСертификация.Ном КАК Ном,
		|		РегСертификация.Серия КАК Серия,
		|		РегСертификация.Сертификация КАК Сертификация,
		|		РегСертификация.ДатаСертификата КАК ДатаСертификата,
		|		РегСертификация.НомерСертификата КАК НомерСертификата,
		|		РегСертификация.Контрагент КАК Контрагент,
		|		РегСертификация.ДокОтказ КАК ДокОтказ,
		|		РегСертификация.ДокОтбора КАК ДокОтбора,
		|		РегСертификация.ДокЗаявки КАК ДокЗаявки,
		|		РегСертификация.ДокСерт КАК ДокСерт,
		|		РегСертификация.СрокГодности КАК СрокГодности,
		|		РазмерПартии.Количество КАК Количество,
		|		РазмерПартии.Серия КАК Серия1
		|	ИЗ
		|		(ВЫБРАТЬ
		|			РегВнешняяСертификация.СерияНоменклатуры.Владелец КАК Ном,
		|			РегВнешняяСертификация.СерияНоменклатуры КАК Серия,
		|			РегВнешняяСертификация.СостояниеСертификации КАК Сертификация,
		|			РегВнешняяСертификация.ДатаСертификата КАК ДатаСертификата,
		|			РегВнешняяСертификация.НомерСертификата КАК НомерСертификата,
		|			РегВнешняяСертификация.Регистратор.ОрганПоСертификации КАК Контрагент,
		|			ВЫБОР
		|				КОГДА РегВнешняяСертификация.СостояниеСертификации = &ВидСертификацииОтказ
		|					ТОГДА РегВнешняяСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокОтказ,
		|			ВЫБОР
		|				КОГДА РегВнешняяСертификация.СостояниеСертификации = &ВидСертификацииОтбор
		|					ТОГДА РегВнешняяСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокОтбора,
		|			ВЫБОР
		|				КОГДА РегВнешняяСертификация.СостояниеСертификации = &ВидСертификацииЗаявка
		|					ТОГДА РегВнешняяСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокЗаявки,
		|			ВЫБОР
		|				КОГДА РегВнешняяСертификация.СостояниеСертификации = &ВидСертификацииСерт
		|					ТОГДА РегВнешняяСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокСерт,
		|			РегВнешняяСертификация.Регистратор.СрокГодностиСертификата КАК СрокГодности
		|		ИЗ
		|			РегистрСведений.СертификацияНоменклатуры КАК РегВнешняяСертификация
		|		ГДЕ
		|			РегВнешняяСертификация.ВидСертификата >= &ВнешнСертификат
		|			И РегВнешняяСертификация.Период >= &ДатаНач
		|			И РегВнешняяСертификация.Период <= &ДатаКон
		|			И (РегВнешняяСертификация.Регистратор.ВидОперации = &ВидОперации
		|					ИЛИ РегВнешняяСертификация.Регистратор.ВидОперации = &ВидОперацииЗаявки
		|					ИЛИ РегВнешняяСертификация.Регистратор.ВидОперации = &ВидыОперацийАктОтбораПробНоменклатуры
		|					ИЛИ РегВнешняяСертификация.Регистратор = НЕОПРЕДЕЛЕНО)) КАК РегСертификация
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				ПоступлениеТоваровУслугТовары.Количество КАК Количество,
		|				ПоступлениеТоваровУслугТовары.СерияНоменклатуры КАК Серия
		|			ИЗ
		|				Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары,
		|				Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
		|			ГДЕ
		|				ПоступлениеТоваровУслуг.Ссылка = ПоступлениеТоваровУслугТовары.Ссылка
		|				И ПоступлениеТоваровУслуг.Проведен
		|				И ПоступлениеТоваровУслуг.ОтражатьВУправленческомУчете
		|				И ПоступлениеТоваровУслуг.ВидОперации = &прмВидОперации
		|" + ТекстЗапроса_ОтчетПроизводстваЗаСмену + ") КАК РазмерПартии
		|			ПО РазмерПартии.Серия = РегСертификация.Серия) КАК Итог
		|"
		+Фильтр+"
		|";
		
		Запрос.Текст = ТекстЗапроса;
		Запрос.УстановитьПараметр("ДатаНач",НачалоДня(ДатаНач));
		Запрос.УстановитьПараметр("ДатаКон",КонецДня(ДатаКон));
		Запрос.УстановитьПараметр("прмВидОперации",Перечисления.ВидыОперацийПоступлениеТоваровУслуг.ПокупкаКомиссия);
		Запрос.УстановитьПараметр("ВидСертификацииЗаявка",Перечисления.СостоянияСертификацииНоменклатуры.Заявка);
		Запрос.УстановитьПараметр("ВидСертификацииСерт",Перечисления.СостоянияСертификацииНоменклатуры.Есть);
		Запрос.УстановитьПараметр("ВидСертификацииОтбор",Перечисления.СостоянияСертификацииНоменклатуры.ОтборПроб);
		Запрос.УстановитьПараметр("ВидСертификацииОтказ",Перечисления.СостоянияСертификацииНоменклатуры.Отказ);
		
		Запрос.УстановитьПараметр("ВнешнСертификат", Перечисления.ВидыСертификацииНоменклатуры.ВнешняяСертификация);
		
		Запрос.УстановитьПараметр("Контрагент",Контрагент);
		Запрос.УстановитьПараметр("ПустойКонтрагент",Справочники.Контрагенты.ПустаяСсылка());
		
		Запрос.УстановитьПараметр("Номенклатура",Номенклатура);
		Запрос.УстановитьПараметр("ВидОперации",Перечисления.ВидыОперацийСертификацияНоменклатуры.Внешняя);
		Запрос.УстановитьПараметр("ВидОперацииЗаявки",Перечисления.ВидыОперацийЗаявкаНаСертификациюНоменклатуры.Внешняя);
		Запрос.УстановитьПараметр("ВидыОперацийАктОтбораПробНоменклатуры",Перечисления.ВидыОперацийАктОтбораПробНоменклатуры.ДляВнешнейСертификации);
		
		ТЗ=Запрос.Выполнить().Выгрузить();
		ТЗ.Сортировать("Контрагент, Ном, Серия");
		
		ТЗКонтр = ТЗ.Скопировать();
		ТЗНом = ТЗ.Скопировать();
		
		ТЗКонтр.Свернуть("Контрагент");
		ТЗНом.Свернуть("Ном");
		
		ТабРеультатов = Новый ТаблицаЗначений;
		ТабРеультатов.Колонки.Добавить("Контрагент");
		ТабРеультатов.Колонки.Добавить("Номенклатура");
		ТабРеультатов.Колонки.Добавить("Количество");	
		ТабРеультатов.Колонки.Добавить("Серия"); 
		ТабРеультатов.Колонки.Добавить("ДокОтказ"); 
		ТабРеультатов.Колонки.Добавить("ДатаОтказ"); 
		ТабРеультатов.Колонки.Добавить("ДокЗаявки"); 
		ТабРеультатов.Колонки.Добавить("ДатаЗаявки"); 
		ТабРеультатов.Колонки.Добавить("ДокПроба"); 
		ТабРеультатов.Колонки.Добавить("ДатаПробы"); 
		ТабРеультатов.Колонки.Добавить("ДокСерт"); 
		ТабРеультатов.Колонки.Добавить("ДатаСерт"); 
		ТабРеультатов.Колонки.Добавить("НомСерт"); 
		ТабРеультатов.Колонки.Добавить("СрокСерт");
		ТабРеультатов.Колонки.Добавить("ПериодСерт");
		
		ТабОтказ = Новый ТаблицаЗначений;
		ТабОтказ.Колонки.Добавить("Док");
		
		ТабЗаявки = Новый ТаблицаЗначений;
		ТабЗаявки.Колонки.Добавить("Док");
		
		ТабСерт = Новый ТаблицаЗначений;
		ТабСерт.Колонки.Добавить("Док");
		
		ТабПробы = Новый ТаблицаЗначений;
		ТабПробы.Колонки.Добавить("Док");
		
		Для каждого СтрокаКонтрагента Из ТЗКонтр Цикл
			Контр = СтрокаКонтрагента.Контрагент;
			Для каждого СтрокаНоменклатуры Из ТЗНом Цикл
				
				Ном = СтрокаНоменклатуры.Ном;
				Структ = Новый Структура;
				Структ.Вставить("Контрагент",Контр);
				Структ.Вставить("Ном",Ном);
				
				Серия ="";
				Строки = ТЗ.НайтиСтроки(Структ);
				Колич = 0;
				МинДатаЗаявки = "";
				МинДатаСерт = "";
				СтОтказ = "";
				СтСерт = "";
				СтЗаявки = "";
				СтПробы = "";
				СрокГодности = "";
				НомерСертификата = "";
				ТабЗаявки.Очистить();
				ТабПробы.Очистить();
				ТабСерт.Очистить();
				ТабОтказ.Очистить();
				
				Если Строки.Количество() > 0 Тогда
					//Тут все серии по данной Номенклатуре и Контрагенту
					Для каждого Строка Из Строки Цикл
						
						Если Серия <> Строка.Серия и Серия <> "" Тогда
							
							Если МинДатаСерт <> "" и МинДатаЗаявки <> "" и МинДатаСерт >= МинДатаЗаявки Тогда
								ПерСерт = 1 + (НачалоДня(МинДатаСерт) - НачалоДня(МинДатаЗаявки)) / 86400;	
							Иначе	
								ПерСерт = 0;
							КонецЕсли; 
							
							СтрокаРезультатов = ТабРеультатов.Добавить();
							СтрокаРезультатов.Контрагент = Контр;
							СтрокаРезультатов.Номенклатура = Ном; 
							СтрокаРезультатов.Серия = Серия; 
							
							СтрокаРезультатов.ДокОтказ = ТабОтказ.Скопировать(); 
							СтрокаРезультатов.ДатаОтказ = СтОтказ; 
							
							СтрокаРезультатов.ДокЗаявки = ТабЗаявки.Скопировать(); 
							СтрокаРезультатов.ДатаЗаявки = СтЗаявки; 
							СтрокаРезультатов.ДокПроба = ТабПробы.Скопировать(); 
							СтрокаРезультатов.ДатаПробы = СтПробы; 
							СтрокаРезультатов.ДокСерт = ТабСерт.Скопировать(); 
							СтрокаРезультатов.ДатаСерт = СтСерт; 
							СтрокаРезультатов.НомСерт = НомерСертификата; 
							СтрокаРезультатов.СрокСерт = СрокГодности;
							СтрокаРезультатов.ПериодСерт = ПерСерт;
							СтрокаРезультатов.Количество = Колич;
							
							Колич = 0;
							МинДатаЗаявки = "";
							МинДатаСерт = "";
							СтОтказ = "";
							СтСерт = "";
							СтЗаявки = "";
							СтПробы = "";
							СрокГодности = "";
							НомерСертификата = "";
							ТабЗаявки.Очистить();
							ТабПробы.Очистить();
							ТабСерт.Очистить();
							
						КонецЕсли;	
						
						Серия = Строка.Серия;
						ДокЗаявки = Строка.ДокЗаявки;
						ДокСерт = Строка.ДокСерт;
						ДокПробы = Строка.ДокОтбора;
						ДокОтказ = Строка.ДокОтказ;
						
						Если Строка.СрокГодности <> Null Тогда
							Если Найти(СрокГодности,Формат(Строка.СрокГодности,"ДФ=dd.MM.yyyy")) = 0 Тогда
								СрокГодности = ?(СрокГодности  = "",СрокГодности ,СрокГодности  + Символы.ПС) + Формат(Строка.СрокГодности,"ДФ=dd.MM.yyyy");
							КонецЕсли; 
						КонецЕсли; 
						
						Если Строка.НомерСертификата <> Null Тогда
							Если Найти(НомерСертификата,СокрЛП(Строка.НомерСертификата)) = 0 Тогда
								НомерСертификата = ?(НомерСертификата = "",НомерСертификата,НомерСертификата + Символы.ПС) + СокрЛП(Строка.НомерСертификата);
							КонецЕсли; 
						КонецЕсли; 
						
						Если Колич = 0 и Строка.РзмерПартии <> Null Тогда
							Колич = Строка.РзмерПартии;
						КонецЕсли;	
						
						Если ДокЗаявки <> Null Тогда
							Если МинДатаЗаявки = "" Тогда
								МинДатаЗаявки = ДокЗаявки.Дата;
							КонецЕсли; 
							
							Если МинДатаЗаявки > ДокЗаявки.Дата Тогда
								МинДатаЗаявки = ДокЗаявки.Дата;					
							КонецЕсли; 
						КонецЕсли; 
						
						Если ДокЗаявки <> Null Тогда
							ДатаЗаявки = Формат(ДокЗаявки.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтЗаявки,ДатаЗаявки) = 0 Тогда
								СтЗаявки = ?(СтЗаявки = "",СтЗаявки,СтЗаявки + Символы.ПС) + ДатаЗаявки;
							КонецЕсли; 
							СтрокаЗаявки = ТабЗаявки.Найти(ДокЗаявки.Ссылка,"Док");
							Если СтрокаЗаявки = Неопределено Тогда
								СтрокаЗаявки = ТабЗаявки.Добавить();
								СтрокаЗаявки.Док = ДокЗаявки.Ссылка;
							КонецЕсли; 
						КонецЕсли;
						
						Если ДокСерт <> Null Тогда
							
							Если МинДатаСерт = "" Тогда
								МинДатаСерт = ДокСерт.Дата;
							КонецЕсли; 
							
							Если МинДатаСерт > ДокСерт.Дата Тогда
								МинДатаСерт = ДокСерт.Дата;					
							КонецЕсли; 
						КонецЕсли; 
						
						Если ДокСерт <> Null Тогда
							ДатаСерт = Формат(ДокСерт.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтСерт,ДатаСерт) = 0 Тогда
								СтСерт = ?(СтСерт = "",СтСерт,СтСерт + Символы.ПС) + ДатаСерт;
							КонецЕсли; 
							СтрокаСерт = ТабСерт.Найти(ДокСерт.Ссылка,"Док");
							Если СтрокаСерт = Неопределено Тогда
								СтрокаСерт = ТабСерт.Добавить();
								СтрокаСерт.Док = ДокСерт.Ссылка;
							КонецЕсли; 
						КонецЕсли;
						
						
						Если ДокОтказ <> Null Тогда
							ДатаОтказ = Формат(ДокОтказ.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтОтказ,ДатаОтказ) = 0 Тогда
								СтОтказ = ?(СтОтказ = "",СтОтказ,СтОтказ + Символы.ПС) + ДатаОтказ;
							КонецЕсли; 
							СтрокаОтказ = ТабОтказ.Найти(ДокОтказ.Ссылка,"Док");
							Если СтрокаОтказ = Неопределено Тогда
								СтрокаОтказ = ТабОтказ.Добавить();
								СтрокаОтказ.Док = ДокОтказ.Ссылка;
							КонецЕсли; 
						КонецЕсли;
						
						Если ДокПробы <> Null Тогда
							ДатаПробы = Формат(ДокПробы.Дата,"ДФ=dd.MM.yyyy");
							Если Найти(СтПробы,ДатаПробы) = 0 Тогда
								СтПробы = ?(СтПробы = "",СтПробы,СтПробы + Символы.ПС) + ДатаПробы;
							КонецЕсли; 
							СтрокаПробы = ТабПробы.Найти(ДокПробы.Ссылка,"Док");
							Если СтрокаПробы = Неопределено Тогда
								СтрокаПробы = ТабПробы.Добавить();
								СтрокаПробы.Док = ДокПробы.Ссылка;
							КонецЕсли; 
						КонецЕсли;
						
					КонецЦикла;  
					Если МинДатаСерт <> "" и МинДатаЗаявки <> "" и МинДатаСерт >= МинДатаЗаявки Тогда
						ПерСерт = 1 + (НачалоДня(МинДатаСерт) - НачалоДня(МинДатаЗаявки)) / 86400;	
					Иначе	
						ПерСерт = 0;
					КонецЕсли; 
					
					СтрокаРезультатов = ТабРеультатов.Добавить();
					СтрокаРезультатов.Контрагент = Контр;
					СтрокаРезультатов.Номенклатура = Ном; 
					СтрокаРезультатов.Серия = Серия; 
					
					СтрокаРезультатов.ДокОтказ = ТабОтказ.Скопировать(); 
					СтрокаРезультатов.ДатаОтказ = СтОтказ; 
					
					СтрокаРезультатов.ДокЗаявки = ТабЗаявки.Скопировать(); 
					СтрокаРезультатов.ДатаЗаявки = СтЗаявки; 
					СтрокаРезультатов.ДокПроба = ТабПробы.Скопировать(); 
					СтрокаРезультатов.ДатаПробы = СтПробы; 
					СтрокаРезультатов.ДокСерт = ТабСерт.Скопировать(); 
					СтрокаРезультатов.ДатаСерт = СтСерт; 
					СтрокаРезультатов.НомСерт = НомерСертификата; 
					СтрокаРезультатов.СрокСерт = СрокГодности;
					СтрокаРезультатов.ПериодСерт = ПерСерт;
					СтрокаРезультатов.Количество = Колич;
				КонецЕсли; 
			КонецЦикла; 
			
		КонецЦикла;  
		
		ДокументРезультат.Очистить();
		Макет = ЭтотОбъект.ПолучитьМакет("Сертификация");
		Секция = Макет.ПолучитьОбласть("Шапка");
		ДокументРезультат.Вывести(Секция);	
		
		СекцияКонтрагента = Макет.ПолучитьОбласть("СтрокаКонтрагента");
		СекцияНоменклатуры = Макет.ПолучитьОбласть("СтрокаНоменклатуры");
		Секция = Макет.ПолучитьОбласть("СтрокаСерии");
		
		ДокументРезультат.НачатьАвтогруппировкуСтрок();
		
		ЧислоСертификаций = 0;
		ОбщееКоличествоДней = 0;
		Для каждого Строка Из ТабРеультатов Цикл
			
			ФлЗаменыКонтрагента = 0;
			
			Если СекцияКонтрагента.Параметры.Контрагент <> Строка.Контрагент Тогда
				ФлЗаменыКонтрагента = 1;
				
				Структ = Новый Структура;
				Структ.Вставить("Контрагент",Строка.Контрагент);
				Строки = ТабРеультатов.НайтиСтроки(Структ);	
				СредКол = 0;
				Кол = 0;
				Если Строки.Количество()>0 Тогда
					Для каждого СтрокаКонтр Из Строки Цикл
						СредКол  = СредКол + СтрокаКонтр.ПериодСерт;
						Если СтрокаКонтр.ПериодСерт <> 0 Тогда
							Кол = Кол + 1;
						КонецЕсли; 
					КонецЦикла; 	
					Если Кол <> 0 Тогда
						СредКол = Окр(СредКол / Кол);
					Иначе
						СредКол = 0;
					КонецЕсли; 
				КонецЕсли; 
				
				СекцияКонтрагента.Параметры.Контрагент = Строка.Контрагент;
				СекцияКонтрагента.Параметры.ПериодСерт = СредКол;
				ДокументРезультат.Вывести(СекцияКонтрагента,1);
			КонецЕсли; 
			
			Если (СекцияНоменклатуры.Параметры.Номенклатура <> Строка.Номенклатура) или (ФлЗаменыКонтрагента = 1) Тогда
				
				Структ.Вставить("Номенклатура",Строка.Номенклатура);
				Строки = ТабРеультатов.НайтиСтроки(Структ);	
				СредКол = 0;
				Кол = 0;
				Если Строки.Количество()>0 Тогда
					Для каждого СтрокаНом Из Строки Цикл
						СредКол  = СредКол + СтрокаНом.ПериодСерт;
						Если СтрокаНом.ПериодСерт <> 0 Тогда
							Кол = Кол + 1;
						КонецЕсли; 
					КонецЦикла; 	
					Если Кол <> 0 Тогда
						СредКол = Окр(СредКол / Кол);
					Иначе
						СредКол = 0;
					КонецЕсли; 
				КонецЕсли; 
				
				СекцияНоменклатуры.Параметры.Номенклатура = Строка.Номенклатура;
				СекцияНоменклатуры.Параметры.ПериодСерт = СредКол;
				ДокументРезультат.Вывести(СекцияНоменклатуры,2);
			КонецЕсли;  	
			
			Секция.Параметры.Заполнить(Строка);	
			ДокументРезультат.Вывести(Секция,3);
			
			ОбщееКоличествоДней = ОбщееКоличествоДней + Строка.ПериодСерт;
			Если Строка.ПериодСерт <> 0 Тогда
				ЧислоСертификаций = ЧислоСертификаций + 1; 
			КонецЕсли; 
		КонецЦикла;  
		
		ДокументРезультат.ЗакончитьАвтогруппировкуСтрок();
		
		Секция=Макет.ПолучитьОбласть("Подвал");
		Секция.Параметры.ДатаОтчета=Формат(ТекущаяДата(),"ДЛФ=Д");
		Если ЧислоСертификаций<>0 Тогда
			СреднееЧисло=Окр(ОбщееКоличествоДней/ЧислоСертификаций);
		Иначе
			СреднееЧисло="";
		КонецЕсли;
		Секция.Параметры.СреднееЧисло=СреднееЧисло;
		ДокументРезультат.Вывести(Секция);
		
	ИначеЕсли Внутренняя Тогда	
		
		Если ЗначениеЗаполнено(Номенклатура) Тогда
			Фильтр = " ГДЕ Ном В ИЕРАРХИИ (&Номенклатура) И Ном ЕСТЬ НЕ NULL";
		КонецЕсли; 
		
		Запрос=Новый Запрос;
		ТекстЗапроса = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Итог.Ном,
		|	ВЫБОР
		|		КОГДА Итог.Серия ЕСТЬ NULL 
		|			ТОГДА ""<Пустая серия>""
		|		ИНАЧЕ Итог.Серия
		|	КОНЕЦ КАК Серия,
		|	Итог.Количество КАК РзмерПартии,
		|	Итог.ДокЗаявки,
		|	Итог.ДокОтказ,
		|	Итог.ДокСерт,
		|	Итог.ДокОтбора
		|ИЗ
		|	(ВЫБРАТЬ
		|		РегСертификация.Ном КАК Ном,
		|		РегСертификация.Серия КАК Серия,
		|		РегСертификация.Сертификация КАК Сертификация,
		|		РегСертификация.ДокОтказ КАК ДокОтказ,
		|		РегСертификация.ДокОтбора КАК ДокОтбора,
		|		РегСертификация.ДокЗаявки КАК ДокЗаявки,
		|		РегСертификация.ДокСерт КАК ДокСерт,
		|		РегСертификация.СрокГодности КАК СрокГодности,
		|		РазмерПартии.Количество КАК Количество,
		|		РазмерПартии.Серия КАК Серия1
		|	ИЗ
		|		(ВЫБРАТЬ
		|			РегВнутрСертификация.СерияНоменклатуры.Владелец КАК Ном,
		|			РегВнутрСертификация.СерияНоменклатуры КАК Серия,
		|			РегВнутрСертификация.СостояниеСертификации КАК Сертификация,
		|			ВЫБОР
		|				КОГДА РегВнутрСертификация.СостояниеСертификации = &ВидСертификацииОтказ
		|					ТОГДА РегВнутрСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокОтказ,
		|			ВЫБОР
		|				КОГДА РегВнутрСертификация.СостояниеСертификации = &ВидСертификацииОтбор
		|					ТОГДА РегВнутрСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокОтбора,
		|			ВЫБОР
		|				КОГДА РегВнутрСертификация.СостояниеСертификации = &ВидСертификацииЗаявка
		|					ТОГДА РегВнутрСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокЗаявки,
		|			ВЫБОР
		|				КОГДА РегВнутрСертификация.СостояниеСертификации = &ВидСертификацииСерт
		|					ТОГДА РегВнутрСертификация.Регистратор.Ссылка
		|			КОНЕЦ КАК ДокСерт,
		|			РегВнутрСертификация.Регистратор.СрокГодностиСертификата КАК СрокГодности
		|		ИЗ
		|			РегистрСведений.СертификацияНоменклатуры КАК РегВнутрСертификация
		|		ГДЕ
		|			РегВнутрСертификация.ВидСертификата = &ВнутрСертификат
		|			И РегВнутрСертификация.Период >= &ДатаНач
		|			И РегВнутрСертификация.Период <= &ДатаКон
		|			И (РегВнутрСертификация.Регистратор.ВидОперации = &ВидОперации
		|					ИЛИ РегВнутрСертификация.Регистратор.ВидОперации = &ВидОперацииЗаявки
		|					ИЛИ РегВнутрСертификация.Регистратор.ВидОперации = &ВидыОперацийАктОтбораПробНоменклатуры
		|					ИЛИ РегВнутрСертификация.Регистратор = НЕОПРЕДЕЛЕНО)) КАК РегСертификация
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				ПоступлениеТоваровУслугТовары.Количество КАК Количество,
		|				ПоступлениеТоваровУслугТовары.СерияНоменклатуры КАК Серия
		|			ИЗ
		|				Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары,
		|				Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
		|			ГДЕ
		|				ПоступлениеТоваровУслуг.Ссылка = ПоступлениеТоваровУслугТовары.Ссылка
		|				И ПоступлениеТоваровУслуг.Проведен
		|				И ПоступлениеТоваровУслуг.ОтражатьВУправленческомУчете
		|				И ПоступлениеТоваровУслуг.ВидОперации = &прмВидОперации
		|" + ТекстЗапроса_ОтчетПроизводстваЗаСмену + ") КАК РазмерПартии
		|			ПО РазмерПартии.Серия = РегСертификация.Серия) КАК Итог
		|"
		+Фильтр+"
		|";
		Запрос.Текст = ТекстЗапроса;
		Запрос.УстановитьПараметр("ДатаНач",НачалоДня(ДатаНач));
		Запрос.УстановитьПараметр("ДатаКон",КонецДня(ДатаКон));
		Запрос.УстановитьПараметр("прмВидОперации",Перечисления.ВидыОперацийПоступлениеТоваровУслуг.ПокупкаКомиссия);
		Запрос.УстановитьПараметр("ВидСертификацииЗаявка",Перечисления.СостоянияСертификацииНоменклатуры.Заявка);
		Запрос.УстановитьПараметр("ВидСертификацииСерт",Перечисления.СостоянияСертификацииНоменклатуры.Есть);
		Запрос.УстановитьПараметр("ВидСертификацииОтбор",Перечисления.СостоянияСертификацииНоменклатуры.ОтборПроб);
		Запрос.УстановитьПараметр("ВидСертификацииОтказ",Перечисления.СостоянияСертификацииНоменклатуры.Отказ);
		
		Запрос.УстановитьПараметр("ВнутрСертификат", Перечисления.ВидыСертификацииНоменклатуры.ВнутренняяСертификация);
		
		Запрос.УстановитьПараметр("Номенклатура",Номенклатура);
		Запрос.УстановитьПараметр("ВидОперации",Перечисления.ВидыОперацийСертификацияНоменклатуры.внутренняя);
		Запрос.УстановитьПараметр("ВидОперацииЗаявки",Перечисления.ВидыОперацийЗаявкаНаСертификациюНоменклатуры.внутренняя);
		Запрос.УстановитьПараметр("ВидыОперацийАктОтбораПробНоменклатуры",Перечисления.ВидыОперацийАктОтбораПробНоменклатуры.ДляВнутреннейСертификации);
		
		ТЗ=Запрос.Выполнить().Выгрузить();
		ТЗ.Сортировать("Ном, Серия");
		
		ТЗНом = ТЗ.Скопировать();
		
		ТЗНом.Свернуть("Ном");
		
		ТабРеультатов = Новый ТаблицаЗначений;
		ТабРеультатов.Колонки.Добавить("Номенклатура");
		ТабРеультатов.Колонки.Добавить("Количество");	
		ТабРеультатов.Колонки.Добавить("Серия"); 
		ТабРеультатов.Колонки.Добавить("ДокОтказ"); 
		ТабРеультатов.Колонки.Добавить("ДатаОтказ"); 
		
		ТабРеультатов.Колонки.Добавить("ДокЗаявки"); 
		ТабРеультатов.Колонки.Добавить("ДатаЗаявки"); 
		ТабРеультатов.Колонки.Добавить("ДокПроба"); 
		ТабРеультатов.Колонки.Добавить("ДатаПробы"); 
		ТабРеультатов.Колонки.Добавить("ДокСерт"); 
		ТабРеультатов.Колонки.Добавить("ДатаСерт"); 
		ТабРеультатов.Колонки.Добавить("ПериодСерт");
		
		ТабЗаявки = Новый ТаблицаЗначений;
		ТабЗаявки.Колонки.Добавить("Док");
		
		ТабСерт = Новый ТаблицаЗначений;
		ТабСерт.Колонки.Добавить("Док");
		
		ТабПробы = Новый ТаблицаЗначений;
		ТабПробы.Колонки.Добавить("Док");
		
		ТабОтказ = Новый ТаблицаЗначений;
		ТабОтказ.Колонки.Добавить("Док");
		
		Для каждого СтрокаНоменклатуры Из ТЗНом Цикл
			
			Ном = СтрокаНоменклатуры.Ном;
			Структ = Новый Структура;
			Структ.Вставить("Ном",Ном);
			
			Серия ="";
			Строки = ТЗ.НайтиСтроки(Структ);
			Колич = 0;
			МинДатаЗаявки = "";
			МинДатаСерт = "";
			СтОтказ = "";
			СтСерт = "";
			СтЗаявки = "";
			СтПробы = "";
			ТабЗаявки.Очистить();
			ТабПробы.Очистить();
			ТабСерт.Очистить();
			ТабОтказ.Очистить();
			
			Если Строки.Количество() > 0 Тогда
				//Тут все серии по данной Номенклатуре и Контрагенту
				Для каждого Строка Из Строки Цикл
					
					Если Серия <> Строка.Серия и Серия <> "" Тогда
						
						Если МинДатаСерт <> "" и МинДатаЗаявки <> "" и МинДатаСерт >= МинДатаЗаявки Тогда
							ПерСерт = 1 + (НачалоДня(МинДатаСерт) - НачалоДня(МинДатаЗаявки)) / 86400;	
						Иначе	
							ПерСерт = 0;
						КонецЕсли; 
						
						СтрокаРезультатов = ТабРеультатов.Добавить();
						СтрокаРезультатов.Номенклатура = Ном; 
						СтрокаРезультатов.Серия = Серия; 
						СтрокаРезультатов.ДокОтказ = ТабОтказ.Скопировать(); 
						СтрокаРезультатов.ДатаОтказ = СтОтказ; 
						
						СтрокаРезультатов.ДокЗаявки = ТабЗаявки.Скопировать(); 
						СтрокаРезультатов.ДатаЗаявки = СтЗаявки; 
						СтрокаРезультатов.ДокПроба = ТабПробы.Скопировать(); 
						СтрокаРезультатов.ДатаПробы = СтПробы; 
						СтрокаРезультатов.ДокСерт = ТабСерт.Скопировать(); 
						СтрокаРезультатов.ДатаСерт = СтСерт; 
						СтрокаРезультатов.ПериодСерт = ПерСерт;
						СтрокаРезультатов.Количество = Колич;
						
						Колич = 0;
						МинДатаЗаявки = "";
						МинДатаСерт = "";
						СтСерт = "";
						СтЗаявки = "";
						СтПробы = "";
						СтОтказ = "";
						ТабЗаявки.Очистить();
						ТабПробы.Очистить();
						ТабСерт.Очистить();
						ТабОтказ.Очистить();
						
					КонецЕсли;	
					
					Серия = Строка.Серия;
					ДокЗаявки = Строка.ДокЗаявки;
					ДокСерт = Строка.ДокСерт;
					ДокПробы = Строка.ДокОтбора;
					ДокОтказ = Строка.ДокОтказ;
					
					Если Колич = 0 и Строка.РзмерПартии <> Null Тогда
						Колич = Строка.РзмерПартии;
					КонецЕсли;	
					
					Если ДокЗаявки <> Null Тогда
						Если МинДатаЗаявки = "" Тогда
							МинДатаЗаявки = ДокЗаявки.Дата;
						КонецЕсли; 
						
						Если МинДатаЗаявки > ДокЗаявки.Дата Тогда
							МинДатаЗаявки = ДокЗаявки.Дата;					
						КонецЕсли; 
					КонецЕсли; 
					
					Если ДокЗаявки <> Null Тогда
						ДатаЗаявки = Формат(ДокЗаявки.Дата,"ДФ=dd.MM.yyyy");
						Если Найти(СтЗаявки,ДатаЗаявки) = 0 Тогда
							СтЗаявки = ?(СтЗаявки = "",СтЗаявки,СтЗаявки + Символы.ПС) + ДатаЗаявки;
						КонецЕсли; 
						СтрокаЗаявки = ТабЗаявки.Найти(ДокЗаявки.Ссылка,"Док");
						Если СтрокаЗаявки = Неопределено Тогда
							СтрокаЗаявки = ТабЗаявки.Добавить();
							СтрокаЗаявки.Док = ДокЗаявки.Ссылка;
						КонецЕсли; 
					КонецЕсли;
					
					Если ДокСерт <> Null Тогда
						
						Если МинДатаСерт = "" Тогда
							МинДатаСерт = ДокСерт.Дата;
						КонецЕсли; 
						
						Если МинДатаСерт > ДокСерт.Дата Тогда
							МинДатаСерт = ДокСерт.Дата;					
						КонецЕсли; 
					КонецЕсли; 
					
					Если ДокСерт <> Null Тогда
						ДатаСерт = Формат(ДокСерт.Дата,"ДФ=dd.MM.yyyy");
						Если Найти(СтСерт,ДатаСерт) = 0 Тогда
							СтСерт = ?(СтСерт = "",СтСерт,СтСерт + Символы.ПС) + ДатаСерт;
						КонецЕсли; 
						СтрокаСерт = ТабСерт.Найти(ДокСерт.Ссылка,"Док");
						Если СтрокаСерт = Неопределено Тогда
							СтрокаСерт = ТабСерт.Добавить();
							СтрокаСерт.Док = ДокСерт.Ссылка;
						КонецЕсли; 
					КонецЕсли;
					
					Если ДокОтказ <> Null Тогда
						ДатаОтказ = Формат(ДокОтказ.Дата,"ДФ=dd.MM.yyyy");
						Если Найти(СтОтказ,ДатаОтказ) = 0 Тогда
							СтОтказ = ?(СтОтказ = "",СтОтказ,СтОтказ + Символы.ПС) + ДатаОтказ;
						КонецЕсли; 
						СтрокаОтказ = ТабОтказ.Найти(ДокОтказ.Ссылка,"Док");
						Если СтрокаОтказ = Неопределено Тогда
							СтрокаОтказ = ТабОтказ.Добавить();
							СтрокаОтказ.Док = ДокОтказ.Ссылка;
						КонецЕсли; 
					КонецЕсли;
					
					Если ДокПробы <> Null Тогда
						ДатаПробы = Формат(ДокПробы.Дата,"ДФ=dd.MM.yyyy");
						Если Найти(СтПробы,ДатаПробы) = 0 Тогда
							СтПробы = ?(СтПробы = "",СтПробы,СтПробы + Символы.ПС) + ДатаПробы;
						КонецЕсли; 
						СтрокаПробы = ТабПробы.Найти(ДокПробы.Ссылка,"Док");
						Если СтрокаПробы = Неопределено Тогда
							СтрокаПробы = ТабПробы.Добавить();
							СтрокаПробы.Док = ДокПробы.Ссылка;
						КонецЕсли; 
					КонецЕсли;
					
				КонецЦикла;  
				Если МинДатаСерт <> "" и МинДатаЗаявки <> "" и МинДатаСерт >= МинДатаЗаявки Тогда
					ПерСерт = 1 + (НачалоДня(МинДатаСерт) - НачалоДня(МинДатаЗаявки)) / 86400;	
				Иначе	
					ПерСерт = 0;
				КонецЕсли; 
				
				СтрокаРезультатов = ТабРеультатов.Добавить();
				СтрокаРезультатов.Номенклатура = Ном; 
				СтрокаРезультатов.Серия = Серия; 
				СтрокаРезультатов.ДокЗаявки = ТабЗаявки.Скопировать(); 
				СтрокаРезультатов.ДатаЗаявки = СтЗаявки; 
				СтрокаРезультатов.ДокПроба = ТабПробы.Скопировать(); 
				СтрокаРезультатов.ДатаПробы = СтПробы; 
				СтрокаРезультатов.ДокСерт = ТабСерт.Скопировать(); 
				СтрокаРезультатов.ДатаСерт = СтСерт; 
				СтрокаРезультатов.ПериодСерт = ПерСерт;
				СтрокаРезультатов.Количество = Колич;
				СтрокаРезультатов.ДокОтказ = ТабОтказ.Скопировать(); 
				СтрокаРезультатов.ДатаОтказ = СтОтказ; 
				
			КонецЕсли; 
		КонецЦикла; 
		
		ДокументРезультат.Очистить();
		Макет = ЭтотОбъект.ПолучитьМакет("Сертификация");
		Секция = Макет.ПолучитьОбласть("ШапкаВнут");
		ДокументРезультат.Вывести(Секция);	
		
		СекцияНоменклатуры = Макет.ПолучитьОбласть("СтрокаНоменклатурыВнут");
		Секция = Макет.ПолучитьОбласть("СтрокаСерииВнут");
		
		ДокументРезультат.НачатьАвтогруппировкуСтрок();
		
		ЧислоСертификаций = 0;
		ОбщееКоличествоДней = 0;
		Для каждого Строка Из ТабРеультатов Цикл
			
			Если (СекцияНоменклатуры.Параметры.Номенклатура <> Строка.Номенклатура) Тогда
				Структ = Новый Структура;
				Структ.Вставить("Номенклатура",Строка.Номенклатура);
				Строки = ТабРеультатов.НайтиСтроки(Структ);	
				СредКол = 0;
				Кол = 0;
				Если Строки.Количество() > 0 Тогда
					Для каждого СтрокаНом Из Строки Цикл
						СредКол  = СредКол + СтрокаНом.ПериодСерт;
						Если СтрокаНом.ПериодСерт <> 0 Тогда
							Кол = Кол + 1;
						КонецЕсли; 
					КонецЦикла; 	
					Если Кол <> 0 Тогда
						СредКол = Окр(СредКол / Кол);
					Иначе
						СредКол = 0;
					КонецЕсли; 
				КонецЕсли; 
				
				СекцияНоменклатуры.Параметры.Номенклатура = Строка.Номенклатура;
				СекцияНоменклатуры.Параметры.ПериодСерт = СредКол;
				ДокументРезультат.Вывести(СекцияНоменклатуры,2);
			КонецЕсли;  	
			
			Секция.Параметры.Заполнить(Строка);	
			ДокументРезультат.Вывести(Секция,3);
			
			ОбщееКоличествоДней = ОбщееКоличествоДней + Строка.ПериодСерт;
			Если Строка.ПериодСерт <> 0 Тогда
				ЧислоСертификаций = ЧислоСертификаций + 1; 
			КонецЕсли; 
		КонецЦикла;  
		
		ДокументРезультат.ЗакончитьАвтогруппировкуСтрок();
		
		Секция=Макет.ПолучитьОбласть("ПодвалВнут");
		Секция.Параметры.ДатаОтчета = Формат(ТекущаяДата(),"ДЛФ=Д");
		Если ЧислоСертификаций <> 0 Тогда
			СреднееЧисло = Окр(ОбщееКоличествоДней/ЧислоСертификаций);
		Иначе
			СреднееЧисло = "";
		КонецЕсли;
		Секция.Параметры.СреднееЧисло=СреднееЧисло;
		ДокументРезультат.Вывести(Секция);
	КонецЕсли; 
	
	
КонецПроцедуры
 
#КонецЕсли
